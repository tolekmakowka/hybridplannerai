<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Ankieta: Indywidualny plan treningowy</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 clamp(24px,5vw,34px)/1.2 Poppins;margin:0 0 8px}
h2{font:700 18px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}
.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{background:#111;color:#fff;border:1px solid #333;padding:6px 10px;border-radius:10px;font:600 12px/1 Inter;text-decoration:none}
.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.badge{display:inline-flex;align-items:center;gap:8px;border:1px dashed #3a3a3a;padding:6px 10px;border-radius:999px;font-size:12px;color:#cfcfcf}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}
.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}
.helper{font-size:12px;color:#a9a7a3}
.success{display:none; margin-top:14px; background:#102a12; border:1px solid #1f5f22; color:#dff3e0; padding:12px; border-radius:12px}
.error{display:none; margin-top:14px; background:#2a1010; border:1px solid #5f1f1f; color:#f3dfe0; padding:12px; border-radius:12px}
.copybox{display:grid;gap:8px;background:#0f0f0f;border:1px solid #3a3a3a;border-radius:12px;padding:10px;margin-top:10px}
pre{margin:0;white-space:pre-wrap;word-break:break-word;font:400 12px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace;color:#ddd}
.hidden{display:none!important}
.banner{display:flex;gap:10px;align-items:center;background:#112416;border:1px solid #1f4d2a;color:#cfead7;border-radius:12px;padding:10px 12px;margin:0 0 12px}
@media (max-width:700px){ .grid-2{grid-template-columns:1fr} }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="badge" id="badge">Indywidualny plan treningowy</span>
      <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
    </div>
  </div>

  <!-- (Pozostawione dla zgodności, ale niewykorzystywane w nowym flow) -->
  <div id="purchaseGate" class="card hidden">
    <h1 id="gateTitle">Dostęp do ankiety</h1>
    <p id="gateDesc" class="helper" style="margin:6px 0 14px">
      Aby wypełnić ankietę do indywidualnego planu i przekazać odpowiedzi trenerowi, najpierw opłać dostęp.
    </p>
    <div class="actions">
      <button id="payBtn" class="btn btn-brown">Przejdź do płatności — 129,99&nbsp;zł</button>
    </div>
    <div class="notice">
      <small id="gateWhoLbl">E-mail kontaktowy:</small>
      <small id="gateRodo">To nie jest porada medyczna.</small>
    </div>
  </div>

  <!-- FORM: dostępny od razu; płatność po submit -->
  <div id="formCard" class="card">
    <div class="banner hidden" id="paidBanner"><strong id="paidOk">Płatność potwierdzona.</strong> <span id="paidNext">Wysyłam Twoje odpowiedzi…</span></div>

    <h1 id="title">Ankieta — Indywidualny plan treningowy</h1>
    <p id="intro" class="helper" style="margin:6px 0 14px">Uzupełnij krótki formularz. Odpowiedzi trafią bezpośrednio do mnie, abym przygotował Twój plan.</p>

    <form id="survey" novalidate>
      <div class="row">
        <label for="ig" id="lblIg">Jak nazywasz się na Instagramie? <span class="helper" id="lblIgHelp">(informacja potrzebna w celach kontaktowych)</span></label>
        <input id="ig" name="instagram" type="text" inputmode="text" autocomplete="username" placeholder="np. @twojnick" required>
      </div>

      <div class="grid-2">
        <div class="row">
          <label for="age" id="lblAge">W jakim jesteś wieku?</label>
          <input id="age" name="age" type="number" min="10" max="100" step="1" placeholder="np. 25" required>
        </div>

        <div class="row">
          <label for="sessions" id="lblSessions">Ile razy w tygodniu chciałbyś trenować?</label>
          <input id="sessions" name="sessions" type="number" min="1" max="14" step="1" placeholder="np. 3" required>
        </div>
      </div>

      <div class="row">
        <label for="level" id="lblLevel">Jaki jest Twój poziom aktywności fizycznej?</label>
        <select id="level" name="level" required>
          <option value="" selected disabled>Wybierz…</option>
          <option>Początkujący</option>
          <option>Średniozaawansowany</option>
          <option>Zaawansowany</option>
        </select>
      </div>

      <div class="row">
        <label for="goal" id="lblGoal">Jaki jest Twój główny cel?</label>
        <textarea id="goal" name="goal" placeholder="np. redukcja tkanki tłuszczowej / zwiększenie siły / rekompozycja…" required></textarea>
      </div>

      <div class="hr"></div>

      <div class="actions">
        <button id="sendBtn" class="btn btn-brown" type="submit">Wyślij ankietę</button>
        <button id="clearBtn" class="btn btn-ghost" type="button">Wyczyść</button>
      </div>

      <div id="success" class="success">Dziękuję! Ankieta została wysłana. Odezwię się w wiadomości prywatnej lub na e-mailu.</div>
      <div id="error" class="error">
        Nie udało się wysłać ankiety automatycznie. Możesz skopiować odpowiedzi i wysłać ręcznie na
        <a href="mailto:tolek.makowka@gmail.com" style="text-decoration:underline;color:#ffd8db">tolek.makowka@gmail.com</a>.
        <div class="copybox">
          <pre id="fallbackText"></pre>
          <button id="copyBtn" type="button" class="btn btn-ghost" style="justify-self:start">Kopiuj odpowiedzi</button>
        </div>
      </div>
    </form>

    <div class="notice" style="margin-top:16px">
      <small><strong id="whoLbl">E-mail kontaktowy:</strong> <span id="who">—</span></small>
      <small id="rodoLbl">To nie jest porada medyczna.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<script>
/* ====== Endpoints / Settings ====== */
const HP = {
  sendEmail: '/.netlify/functions/send-email',
  checkoutPrimary:  '/.netlify/functions/create-checkout-session',
  checkoutFallback: '/.netlify/functions/create-checkout',
  verifySession: '/.netlify/functions/verify-session'
};
const ADMIN_EMAIL = 'tolek.makowka@gmail.com';

/* ====== Helpers ====== */
function $(id){ return document.getElementById(id); }
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function sanitize(s){ return String(s||'').trim(); }
function tIsEN(){ return (document.documentElement.lang||'pl').toLowerCase()==='en'; }

/* ====== Email in UI ====== */
(function(){
  const email = localStorage.getItem('hp_email') || '';
  $('who').textContent = email || '—';
})();

/* ====== Stripe Checkout (CUSTOM) ====== */
async function tryCreateCheckout(endpoint, payload){
  const r = await fetch(endpoint, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const txt = await r.text();
  let data = null; try { data = JSON.parse(txt) } catch {}
  if(!r.ok || !data?.url) throw new Error((data && (data.error||data.details)) || txt || 'checkout failed');
  return data.url;
}
async function createCheckoutCustom(){
  const email = localStorage.getItem('hp_email') || '';
  const base = window.location.origin + window.location.pathname;
  // create-checkout.js dopisze session_id i checkout=success gdy successUrl pominiemy
  const payload = { email, product: 'custom' };
  try { return await tryCreateCheckout(HP.checkoutPrimary, payload); }
  catch { return await tryCreateCheckout(HP.checkoutFallback, payload); }
}

/* ====== Form helpers ====== */
const survey   = $('survey');
const sendBtn  = $('sendBtn');
const clearBtn = $('clearBtn');
const okBox    = $('success');
const errBox   = $('error');
const fallbackText = $('fallbackText');

function collectValues(){
  return {
    instagram: sanitize($('ig').value),
    age: Number($('age').value || 0),
    sessions: Number($('sessions').value || 0),
    level: sanitize($('level').value),
    goal: sanitize($('goal').value),
    emailFromGate: sanitize(localStorage.getItem('hp_email') || '')
  };
}
function validate(v){
  const issues = [];
  if (!v.instagram || v.instagram.length < 2) issues.push(tIsEN() ? 'Enter your Instagram handle.' : 'Podaj nazwę z Instagrama.');
  if (!v.age || v.age < 10 || v.age > 100) issues.push(tIsEN() ? 'Age should be 10–100.' : 'Wiek powinien być między 10 a 100.');
  if (!v.sessions || v.sessions < 1 || v.sessions > 14) issues.push(tIsEN() ? 'Sessions per week: 1–14.' : 'Liczba treningów 1–14/tydz.');
  if (!v.level) issues.push(tIsEN() ? 'Select your level.' : 'Wybierz poziom aktywności.');
  if (!v.goal || v.goal.length < 3) issues.push(tIsEN() ? 'Describe your main goal.' : 'Opisz swój główny cel.');
  return issues;
}
function buildEmailHTML(v){
  const when = new Date().toLocaleString();
  const esc = (t)=>String(t).replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
  return `
    <h2>Nowa ankieta – Indywidualny plan treningowy</h2>
    <p><strong>Data:</strong> ${esc(when)}</p>
    <table cellpadding="6" cellspacing="0" border="1" style="border-collapse:collapse;border:1px solid #ddd">
      <tr><td><strong>Instagram</strong></td><td>${esc(v.instagram)}</td></tr>
      <tr><td><strong>Wiek</strong></td><td>${esc(v.age)}</td></tr>
      <tr><td><strong>Treningi/tydz.</strong></td><td>${esc(v.sessions)}</td></tr>
      <tr><td><strong>Poziom aktywności</strong></td><td>${esc(v.level)}</td></tr>
      <tr><td><strong>Główny cel</strong></td><td>${esc(v.goal)}</td></tr>
      <tr><td><strong>E-mail</strong></td><td>${esc(v.emailFromGate || '—')}</td></tr>
    </table>
    <p style="margin-top:10px">Źródło: ankieta.html</p>
  `;
}
function buildPlainText(v){
  const when = new Date().toLocaleString();
  return [
    'Nowa ankieta — Indywidualny plan treningowy',
    'Data: ' + when,
    'Instagram: ' + v.instagram,
    'Wiek: ' + v.age,
    'Treningi/tydz.: ' + v.sessions,
    'Poziom aktywności: ' + v.level,
    'Główny cel: ' + v.goal,
    'E-mail: ' + (v.emailFromGate || '—')
  ].join('\n');
}
async function sendEmail(v){
  const payload = {
    to: ADMIN_EMAIL,
    subject: 'Ankieta (indywidualny plan) — ' + (v.instagram || 'nowa odpowiedź'),
    html: buildEmailHTML(v)
  };
  const res = await fetch(HP.sendEmail, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    throw new Error(txt || 'send-email failed');
  }
}

/* ====== Submit: NAJPIERW ankieta -> POTEM płatność ====== */
survey.addEventListener('submit', async (e)=>{
  e.preventDefault();
  okBox.style.display='none'; errBox.style.display='none';

  const v = collectValues();
  const issues = validate(v);
  if (issues.length){ alert(issues.join('\n')); return; }

  // zapisz odpowiedzi na czas płatności
  sessionStorage.setItem('hp_form_custom', JSON.stringify(v));

  // przekierowanie do Stripe
  try{
    sendBtn.disabled = true;
    sendBtn.textContent = tIsEN() ? 'Connecting to Stripe…' : 'Łączenie ze Stripe…';
    const url = await createCheckoutCustom();
    window.location.href = url;
  }catch(e2){
    console.error(e2);
    alert((tIsEN() ? 'Could not start payment: ' : 'Nie udało się rozpocząć płatności: ') + String(e2.message||e2));
  }finally{
    sendBtn.disabled = false;
    sendBtn.textContent = tIsEN() ? 'Send survey' : 'Wyślij ankietę';
  }
});

/* ====== Autoresume: po powrocie ze Stripe -> wyślij ankietę ====== */
async function resumeAfterPaymentIfNeeded(){
  const p = new URLSearchParams(location.search);
  if (p.get('checkout') !== 'success') return;

  show($('paidBanner'));

  // Potwierdź status sesji (opcjonalnie pobierz email ze Stripe)
  const sid = p.get('session_id') || p.get('sessionId') || '';
  if (sid){
    try{
      const r = await fetch(HP.verifySession + '?session_id=' + encodeURIComponent(sid), { method:'GET' });
      const data = await r.json().catch(()=>null);
      if (data && data.ok && data.paid){
        const stripeEmail = data.email || '';
        if (stripeEmail && !localStorage.getItem('hp_email')){
          localStorage.setItem('hp_email', stripeEmail);
          $('who').textContent = stripeEmail;
        }
      }
    }catch(e){ console.warn('verify-session failed', e); }
  }

  // Usuń parametry z paska adresu
  history.replaceState({}, '', window.location.pathname);

  const raw = sessionStorage.getItem('hp_form_custom');
  if (!raw){
    // brak odpowiedzi w storage – poproś o ponowne wypełnienie
    alert(tIsEN()
      ? 'Payment confirmed, but the survey answers were not found. Please fill the form again.'
      : 'Płatność potwierdzona, ale nie znaleziono odpowiedzi ankiety. Wypełnij formularz ponownie.');
    return;
  }

  const v = JSON.parse(raw);
  try{
    await sendEmail(v);
    okBox.style.display='block';
    survey.reset();
  }catch(err){
    console.error(err);
    fallbackText.textContent = buildPlainText(v);
    errBox.style.display='block';
  }finally{
    sessionStorage.removeItem('hp_form_custom');
  }
}

/* ====== Clear & Copy fallback ====== */
clearBtn.addEventListener('click', ()=>{
  survey.reset(); okBox.style.display='none'; errBox.style.display='none';
});
$('copyBtn').addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(fallbackText.textContent || '');
    $('copyBtn').textContent = tIsEN() ? 'Copied ✓' : 'Skopiowano ✓';
    setTimeout(()=> $('copyBtn').textContent = tIsEN() ? 'Copy answers' : 'Kopiuj odpowiedzi', 1200);
  }catch{
    $('copyBtn').textContent = tIsEN() ? 'Not copied' : 'Nie skopiowano';
    setTimeout(()=> $('copyBtn').textContent = tIsEN() ? 'Copy answers' : 'Kopiuj odpowiedzi', 1200);
  }
});

/* ====== i18n (PL/EN) ====== */
(function () {
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const t = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  const toggleBtn = document.getElementById('langToggle');

  if (lang === 'en') {
    document.documentElement.lang = 'en';
    t('backLbl','← Back');
    t('badge','Custom training plan');

    // Gate texts kept but not used
    t('gateTitle','Access to the survey');
    t('gateDesc','To fill out the survey for a custom plan and send answers to the coach, please complete the payment first.');
    t('gateWhoLbl','Contact e-mail:');
    t('gateRodo','This is not medical advice.');

    // Form
    t('paidOk','Payment confirmed.');
    t('paidNext','Sending your answers…');
    t('title','Survey — Custom training plan');
    t('intro','Fill out a short form. Your answers will go directly to me so I can prepare your plan.');
    t('lblIg','What is your Instagram handle? ');
    t('lblIgHelp','(used for contact purposes)');
    t('lblAge','How old are you?');
    t('lblSessions','How many sessions per week would you like?');
    t('lblLevel','What is your training level?');
    t('lblGoal','What is your main goal?');

    t('sendBtn','Send survey'); t('clearBtn','Clear');
    t('success','Thank you! The survey has been sent. I will reach out via DM or e-mail.');
    t('whoLbl','Contact e-mail:');
    t('rodoLbl','This is not medical advice.');

    if (toggleBtn){ toggleBtn.href='?lang=pl'; toggleBtn.textContent='PL'; toggleBtn.setAttribute('aria-label','Polska wersja'); }
    localStorage.setItem('hp_lang','en');
  } else {
    document.documentElement.lang = 'pl';
    t('backLbl','← Wróć');
    t('badge','Indywidualny plan treningowy');

    // Gate (not used)
    t('gateTitle','Dostęp do ankiety');
    t('gateDesc','Aby wypełnić ankietę do indywidualnego planu i przekazać odpowiedzi trenerowi, najpierw opłać dostęp.');
    t('gateWhoLbl','E-mail kontaktowy:');
    t('gateRodo','To nie jest porada medyczna.');

    // Form
    t('paidOk','Płatność potwierdzona.');
    t('paidNext','Wysyłam Twoje odpowiedzi…');
    t('title','Ankieta — Indywidualny plan treningowy');
    t('intro','Uzupełnij krótki formularz. Odpowiedzi trafią bezpośrednio do mnie, abym przygotował Twój plan.');
    t('lblIg','Jak nazywasz się na Instagramie? ');
    t('lblIgHelp','(informacja potrzebna w celach kontaktowych)');
    t('lblAge','W jakim jesteś wieku?');
    t('lblSessions','Ile razy w tygodniu chciałbyś trenować?');
    t('lblLevel','Jaki jest Twój poziom aktywności fizycznej?');
    t('lblGoal','Jaki jest Twój główny cel?');

    t('sendBtn','Wyślij ankietę'); t('clearBtn','Wyczyść');
    t('success','Dziękuję! Ankieta została wysłana. Odezwię się w wiadomości prywatnej lub na e-mailu.');
    t('whoLbl','E-mail kontaktowy:');
    t('rodoLbl','To nie jest porada medyczna.');

    if (toggleBtn){ toggleBtn.href='?lang=en'; toggleBtn.textContent='EN'; toggleBtn.setAttribute('aria-label','English version'); }
    localStorage.setItem('hp_lang','pl');
  }
})();

/* Start autoresume (po powrocie ze Stripe) */
resumeAfterPaymentIfNeeded();
</script>
</body>
</html>
