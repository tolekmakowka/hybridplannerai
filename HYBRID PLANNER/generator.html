<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF; --beige:#8D8C87;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 34px/1.2 Poppins;margin:0 0 8px}
h2{font:700 22px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}
.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{background:#111;color:#fff;border:1px solid #333;padding:6px 10px;border-radius:10px;font:600 12px/1 Inter;text-decoration:none}
.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], input[type="email"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}
.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}
@media (max-width:700px){ .grid-2{grid-template-columns:1fr} }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
  </div>

  <div class="card">
    <h1 id="title">Generator planów</h1>
    <p id="subtitle" style="margin:6px 0 14px;color:#C9C7C2">
      Wybierz odpowiedzi i <strong>opłać zamówienie</strong>. Po płatności plan (Excel) zostanie wysłany na Twój e-mail.
    </p>

    <h2 id="hA">Plan — pytania (5)</h2>
    <div class="grid-2">
      <div class="row">
        <label id="a1lbl">Ile razy w tygodniu chciałbyś/chciałabyś ćwiczyć?</label>
        <input id="a1" type="number" min="1" max="14" value="3">
      </div>
      <div class="row">
        <label id="a2lbl">Jaki jest twój główny cel?</label>
        <input id="a2" type="text" placeholder="np. zwiększyć siłę / redukcja tkanki tłuszczowej">
      </div>
      <div class="row">
        <label id="a3lbl">Jaki jest twój poziom aktywności fizycznej?</label>
        <select id="a3">
          <option>Zaawansowany</option>
          <option>Średniozaawansowany</option>
          <option>Początkujący</option>
        </select>
      </div>
      <div class="row">
        <label id="a4lbl">Do jakiego sprzętu treningowego masz dostęp?</label>
        <input id="a4" type="text" placeholder="np. siłownia pełna / hantle + drążek / dom">
      </div>
      <div class="row">
        <label id="a5lbl">Płeć</label>
        <select id="a5">
          <option value="Mężczyzna">Mężczyzna</option>
          <option value="Kobieta">Kobieta</option>
        </select>
      </div>

      <!-- VOUCHER -->
      <div class="row">
        <label for="voucher">Voucher (opcjonalnie)</label>
        <input id="voucher" type="text" placeholder="np. TGMPRJCT">
      </div>
    </div>

    <div class="hr"></div>

    <div class="actions">
      <button id="genBtn" class="btn btn-brown">Wygeneruj plan</button>
      <a id="dlBtn" class="btn btn-ghost" href="#" download="Plan Treningowy.xlsx" style="display:none">Pobierz Excel</a>
    </div>

    <div class="notice">
      <small id="whoLbl">Plan zostanie wysłany na e-mail: <strong id="who"></strong></small>
      <small id="rodoLbl">To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<script>
/* ---------- Endpoints ---------- */
const HP = {
  generate: '/.netlify/functions/generate-plan',
  sendEmail: '/.netlify/functions/send-email',
  checkout:  '/.netlify/functions/create-checkout-session',
  verify:    '/.netlify/functions/verify-session'
};

/* ---------- Bramka e-mail ---------- */
(function(){
  const mail = localStorage.getItem('hp_email');
  const consent = localStorage.getItem('hp_consent');
  if(!mail || !consent){ window.location.href = 'index.html'; }
  else { document.getElementById('who').textContent = mail; }
})();

/* ---------- payload ---------- */
function buildPayload(){
  return {
    type: 'A',
    lang: (document.documentElement.lang || 'pl'),
    inputs: {
      sessionsPerWeek: Number(document.getElementById('a1').value || 0),
      goal: document.getElementById('a2').value.trim(),
      level: document.getElementById('a3').value,
      equipment: document.getElementById('a4').value.trim(),
      gender: document.getElementById('a5').value
    }
  };
}

/* ---------- generate-plan ---------- */
async function callBackendForXlsx(payload){
  const res = await fetch(HP.generate, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const text = await res.text();
  let data = null; try { data = JSON.parse(text) } catch {}
  if (!res.ok || !data) throw new Error(`generate-plan ${res.status}: ${text.slice(0,300)}`);
  if (data.ok === false) throw new Error(data.error || data.details || 'Błąd backendu');
  const base64 = data.fileBase64 || data.xlsxBase64;
  const filename = data.filename || data.xlsxFilename || 'Plan Treningowy.xlsx';
  if (!base64) throw new Error('Brak pliku XLSX w odpowiedzi');
  return { xlsxBase64: base64, xlsxFilename: filename };
}

/* ---------- e-mail ---------- */
async function sendPlanByEmail(base64, filename){
  const to = localStorage.getItem('hp_email') || '';
  if(!to) return;
  const resp = await fetch(HP.sendEmail, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      to,
      subject: 'Twój plan treningowy',
      html: '<p>W załączniku Twój plan (XLSX). Dziękujemy za skorzystanie z HybridPlanner.</p>',
      attachmentBase64: base64,
      filename: filename || 'Plan Treningowy.xlsx'
    })
  });
  if(!resp.ok){ console.warn('send-email error:', await resp.text()); }
}

/* ---------- Stripe Checkout (z voucherem) ---------- */
async function startCheckoutOrFree(payload){
  const email = localStorage.getItem('hp_email') || '';
  const voucher = (document.getElementById('voucher').value || '').trim();

  const r = await fetch(HP.checkout, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email, voucher, inputs: payload.inputs })
  });
  const data = await r.json().catch(()=>null);
  if (!r.ok || data.ok === false) {
    throw new Error((data && (data.error || data.details)) || 'create-checkout failed');
  }
  return data; // { free:true } albo { url: 'https://checkout.stripe.com/...' }
}

/* ---------- UI ---------- */
const genBtn = document.getElementById('genBtn');
const dlBtn  = document.getElementById('dlBtn');

genBtn.addEventListener('click', async ()=>{
  try{
    genBtn.disabled = true; genBtn.textContent = 'Przekierowanie do płatności…';
    dlBtn.style.display='none'; dlBtn.removeAttribute('href');

    const payload = buildPayload();
    sessionStorage.setItem('hp_pending_payload', JSON.stringify(payload));

    const result = await startCheckoutOrFree(payload);

    // Voucher TGMPRJCT => darmo, generujemy od razu
    if (result.free) {
      genBtn.textContent = 'Generowanie…';
      const { xlsxBase64, xlsxFilename } = await callBackendForXlsx(payload);
      const url = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + xlsxBase64;
      dlBtn.href = url; dlBtn.download = xlsxFilename || 'Plan Treningowy.xlsx';
      dlBtn.style.display='inline-flex';
      await sendPlanByEmail(xlsxBase64, xlsxFilename);
      genBtn.textContent = 'Gotowe ✓';
      sessionStorage.removeItem('hp_pending_payload');
      return;
    }

    // Normalny flow: przekierowanie do Stripe
    if (result.url) {
      window.location.href = result.url;
      return;
    }

    throw new Error('Brak URL z Stripe');
  }catch(e){
    console.error(e);
    alert('Nie udało się rozpocząć płatności: ' + String(e.message || e));
    genBtn.textContent = 'Wygeneruj plan';
  }finally{
    genBtn.disabled = false;
  }
});

/* ---------- Po powrocie ze Stripe (weryfikacja płatności) ---------- */
(async function afterStripe(){
  const p = new URLSearchParams(location.search);
  const sid = p.get('session_id');         // Stripe przekazuje session_id
  const cancelled = p.get('cancelled');

  if (cancelled) {
    sessionStorage.removeItem('hp_pending_payload');
    return;
  }
  if (!sid) return;

  try{
    genBtn.disabled = true; genBtn.textContent = 'Sprawdzam płatność…';

    // backend sprawdza status sesji
    const vr = await fetch(`${HP.verify}?id=${encodeURIComponent(sid)}`);
    const v = await vr.json();
    if (!vr.ok || v.ok === false || !v.paid) {
      alert('Płatność nie została potwierdzona.');
      genBtn.textContent = 'Wygeneruj plan';
      return;
    }

    // zapłacone → generujemy plan
    const raw = sessionStorage.getItem('hp_pending_payload');
    const payload = raw ? JSON.parse(raw) : buildPayload();
    genBtn.textContent = 'Generowanie…';
    const { xlsxBase64, xlsxFilename } = await callBackendForXlsx(payload);
    const url = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + xlsxBase64;
    dlBtn.href = url; dlBtn.download = xlsxFilename || 'Plan Treningowy.xlsx';
    dlBtn.style.display='inline-flex';
    await sendPlanByEmail(xlsxBase64, xlsxFilename);
    genBtn.textContent = 'Gotowe ✓';

    // porządek
    sessionStorage.removeItem('hp_pending_payload');
    history.replaceState({}, '', location.pathname);
  }catch(e){
    console.error(e);
    alert('Błąd podczas weryfikacji płatności: ' + String(e.message || e));
    genBtn.textContent = 'Wygeneruj plan';
  }finally{
    genBtn.disabled = false;
  }
})();
</script>
</body>
</html>
