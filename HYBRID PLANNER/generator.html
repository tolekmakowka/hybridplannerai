<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF; --beige:#8D8C87;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 34px/1.2 Poppins;margin:0 0 8px}
h2{font:700 22px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}

.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{
  background:#111; color:#fff; border:1px solid #333;
  padding:6px 10px; border-radius:10px; font:600 12px/1 Inter; text-decoration:none;
}

.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], input[type="email"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.badge{display:inline-block;background:#1e1e1e;border:1px solid #303030;border-radius:999px;padding:6px 10px;font:600 12px/1 Inter;margin-right:8px;margin-bottom:8px}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}

.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}

/* ========= MOBILE POLISH ========= */
section.snap{ min-height: 100svh; }
@media (max-width: 900px){
  .grid-3{ grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 640px){
  .container{ padding: 0 16px; }
  .hero-bg{ padding: 18px; border-radius: 14px; }
  .kicker{ font-size: 12px; }
  h1{ font-size: clamp(26px, 7vw, 34px); }
  h2{ font-size: 24px; }
  p{  font-size: 15px; }
  .btn{ padding: 10px 14px; font-size: 15px; border-radius: 10px; }
  .right-stack{ grid-template-columns: 1fr; gap: 12px; }
  .round{ width:100%; height:auto !important; aspect-ratio:4/3; object-fit:cover; }
  .grid-3{ grid-template-columns: 1fr; gap: 16px; }
  .card-light{ padding: 16px; border-radius: 14px; }
  .autoplay-toggle{ bottom: 10px; right: 10px; padding: 6px 10px; font-size: 12px; }
  .lang-toggle{ top: 10px; right: 10px; padding: 5px 8px; font-size: 11px; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
  </div>

  <div class="card">
    <h1 id="title">Generator planów</h1>
    <p id="subtitle" style="margin:6px 0 14px;color:#C9C7C2">Wybierz tryb, odpowiedz na pytania i wygeneruj plan. PDF zostanie wysłany na Twój e-mail.</p>

    <!-- wybór trybu -->
    <div class="row">
      <label id="modeLbl">Tryb generatora</label>
      <div class="actions">
        <button class="btn btn-ghost" id="btnA">Plan A — 12 tygodni</button>
        <button class="btn btn-ghost" id="btnB">Plan B — Hybrydowy tydzień (4 tygodnie)</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- FORM A (6 pytań) -->
    <section id="formA" style="display:none">
      <h2 id="hA">Plan A — pytania (6)</h2>
      <div class="grid-2">
        <div class="row">
          <label id="a1lbl">Cel główny</label>
          <input id="a1" type="text" placeholder="np. zwiększyć siłę / zredukować tkankę tłuszczową">
        </div>
        <div class="row">
          <label id="a2lbl">Poziom zaawansowania</label>
          <select id="a2">
            <option>Początkujący</option><option>Średniozaawansowany</option><option>Zaawansowany</option>
          </select>
        </div>
        <div class="row">
          <label id="a3lbl">Dostępny czas (h/tyg.)</label>
          <input id="a3" type="number" min="1" max="30" value="4">
        </div>
        <div class="row">
          <label id="a4lbl">Sprzęt</label>
          <input id="a4" type="text" placeholder="np. siłownia pełna / hantle + drążek / tylko masa ciała">
        </div>
        <div class="row">
          <label id="a5lbl">Ograniczenia / kontuzje</label>
          <input id="a5" type="text" placeholder="np. ból kolana, ograniczyć skoki">
        </div>
        <div class="row">
          <label id="a6lbl">Preferencje (dyscypliny)</label>
          <input id="a6" type="text" placeholder="np. siłownia, bieganie">
        </div>
      </div>
    </section>

    <!-- FORM B (10 pytań + 20 dyscyplin) -->
    <section id="formB" style="display:none">
      <h2 id="hB">Plan B — pytania (10)</h2>
      <div class="grid-2">
        <div class="row"><label id="b1lbl">Dyscypliny (wybierz z listy lub wpisz)</label>
          <input id="b1" type="text" placeholder="np. siłownia, bieganie, wspinaczka">
          <small id="b1hint">Szybki wybór poniżej — kliknij, by dodać:</small>
          <div id="chips" style="margin-top:8px"></div>
        </div>
        <div class="row"><label id="b2lbl">Priorytet 1</label><input id="b2" type="text" placeholder="np. bieg 5 km / siła nóg"></div>
        <div class="row"><label id="b3lbl">Priorytet 2</label><input id="b3" type="text" placeholder="opcjonalnie"></div>
        <div class="row"><label id="b4lbl">Liczba jednostek/tydzień</label><input id="b4" type="number" min="1" max="14" value="4"></div>
        <div class="row"><label id="b5lbl">Dostępne dni</label><input id="b5" type="text" placeholder="np. pn, śr, pt, sob"></div>
        <div class="row"><label id="b6lbl">Czas na jednostkę (min)</label><input id="b6" type="number" min="20" max="180" value="60"></div>
        <div class="row"><label id="b7lbl">Poziom</label>
          <select id="b7"><option>Początkujący</option><option>Średniozaawansowany</option><option>Zaawansowany</option></select>
        </div>
        <div class="row"><label id="b8lbl">Sprzęt</label><input id="b8" type="text" placeholder="np. siłownia / dom / ścianka"></div>
        <div class="row"><label id="b9lbl">Ograniczenia</label><input id="b9" type="text" placeholder="np. brak skoków / bez sprintów"></div>
        <div class="row"><label id="b10lbl">Uwagi</label><textarea id="b10" placeholder="dodatkowe informacje"></textarea></div>
      </div>
      <div class="hr"></div>
      <div>
        <label id="quickLbl">Szybki wybór (20 dyscyplin)</label>
        <div class="grid-3" id="discGrid" style="margin-top:8px"></div>
      </div>
    </section>

    <div class="hr"></div>

    <div class="actions">
      <button id="genBtn" class="btn btn-brown">Wygeneruj plan</button>
      <a id="dlBtn" class="btn btn-ghost" href="#" download="plan.pdf" style="display:none">Pobierz PDF</a>
    </div>

    <div class="notice">
      <small id="whoLbl">Plan zostanie wysłany na e-mail: <strong id="who"></strong></small>
      <small id="rodoLbl">To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<!-- jsPDF do generowania PDF w przeglądarce (podmiana bez integrity) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* ---------- Bramka e-mail (pobrana z index.html przez localStorage) ---------- */
(function(){
  const mail = localStorage.getItem('hp_email');
  const consent = localStorage.getItem('hp_consent');
  if(!mail || !consent){
    window.location.href = 'index.html';
  } else {
    document.getElementById('who').textContent = mail;
  }
})();

/* ---------- I18N EN/PL (jak w index) ---------- */
(function(){
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
  const toggleBtn = document.getElementById('langToggle');

  if(lang==='en'){
    t('backLbl','← Back');
    t('title','Plan generator');
    t('subtitle','Choose mode, answer questions, and generate the plan. The PDF will be emailed to you.');

    t('modeLbl','Generator mode');
    document.getElementById('btnA').textContent='Plan A — 12 weeks';
    document.getElementById('btnB').textContent='Plan B — Hybrid week (4 weeks)';

    t('hA','Plan A — questions (6)');
    t('a1lbl','Main goal');
    t('a2lbl','Training level');
    t('a3lbl','Available time (h/week)');
    t('a4lbl','Equipment');
    t('a5lbl','Limitations / injury');
    t('a6lbl','Preferences (disciplines)');

    t('hB','Plan B — questions (10)');
    t('b1lbl','Disciplines (pick or type)');
    t('b1hint','Quick pick below — click to add:');
    t('b2lbl','Priority 1'); t('b3lbl','Priority 2');
    t('b4lbl','Sessions/week'); t('b5lbl','Available days');
    t('b6lbl','Time per session (min)'); t('b7lbl','Level');
    t('b8lbl','Equipment'); t('b9lbl','Limitations'); t('b10lbl','Notes');
    t('quickLbl','Quick pick (20 disciplines)');

    document.getElementById('genBtn').textContent='Generate plan';
    document.getElementById('dlBtn').textContent='Download PDF';

    t('whoLbl','The plan will be sent to: ');
    t('rodoLbl','This is not medical advice. Use at your own risk.');

    localStorage.setItem('hp_lang','en');
    if(toggleBtn){ toggleBtn.href='?lang=pl'; toggleBtn.textContent='PL'; toggleBtn.setAttribute('aria-label','Polish version'); }
  } else {
    localStorage.setItem('hp_lang','pl');
    if(toggleBtn){ toggleBtn.href='?lang=en'; toggleBtn.textContent='EN'; toggleBtn.setAttribute('aria-label','English version'); }
  }
})();

/* ---------- Lista 20 dyscyplin do szybkiego wyboru ---------- */
const DISC = [
  'Siłownia','Bieganie','Wspinaczka','Jazda na rowerze','Pływanie',
  'Joga','Mobility','HIIT','Cross-training','Trening obwodowy',
  'Wioślarz','Sztangi','Kettlebell','Trening kalisteniczny','Pilates',
  'Boks','MMA','Tenis','Badminton','Narciarstwo biegowe'
];
(function(){
  const grid = document.getElementById('discGrid');
  const chips = document.getElementById('chips');
  if(!grid) return;
  DISC.forEach(name=>{
    const b = document.createElement('button');
    b.type='button'; b.className='badge'; b.textContent=name;
    b.addEventListener('click', ()=>{
      const input = document.getElementById('b1');
      const cur = input.value.trim();
      const list = cur ? cur.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if(!list.includes(name)) list.push(name);
      input.value = list.join(', ');
      const c = document.createElement('span'); c.className='badge'; c.textContent=name;
      chips.appendChild(c);
    });
    grid.appendChild(b);
  });
})();

/* ---------- Przełączanie trybu A/B oraz hash #plan= ---------- */
const formA = document.getElementById('formA');
const formB = document.getElementById('formB');
const btnA  = document.getElementById('btnA');
const btnB  = document.getElementById('btnB');

function showA(){ formA.style.display='block'; formB.style.display='none'; btnA.classList.add('btn-brown'); btnB.classList.remove('btn-brown'); }
function showB(){ formA.style.display='none'; formB.style.display='block'; btnB.classList.add('btn-brown'); btnA.classList.remove('btn-brown'); }

btnA.addEventListener('click', showA);
btnB.addEventListener('click', showB);

(function(){
  const h = location.hash;
  if(h && /plan=B/i.test(h)) showB();
  else if(h && /plan=A/i.test(h)) showA();
  else showA();
})();

/* ---------- Budowanie payloadu ---------- */
function buildPayload(){
  const usingA = formA.style.display==='block';
  if(usingA){
    return {
      mode: 'A',
      title: 'Plan Treningowy (12 tygodni)',
      inputs: {
        goal: document.getElementById('a1').value.trim(),
        level: document.getElementById('a2').value,
        hoursPerWeek: Number(document.getElementById('a3').value || 0),
        equipment: document.getElementById('a4').value.trim(),
        limits: document.getElementById('a5').value.trim(),
        prefs: document.getElementById('a6').value.trim(),
      }
    };
  } else {
    return {
      mode: 'B',
      title: 'Hybrydowy Plan Treningowy (4 tygodnie)',
      inputs: {
        disciplines: document.getElementById('b1').value.trim(),
        prio1: document.getElementById('b2').value.trim(),
        prio2: document.getElementById('b3').value.trim(),
        sessionsPerWeek: Number(document.getElementById('b4').value || 0),
        days: document.getElementById('b5').value.trim(),
        minPerSession: Number(document.getElementById('b6').value || 0),
        level: document.getElementById('b7').value,
        equipment: document.getElementById('b8').value.trim(),
        limits: document.getElementById('b9').value.trim(),
        notes: document.getElementById('b10').value.trim(),
      }
    };
  }
}

/* ---------- Fallback lokalny (placeholder) ---------- */
function localGenerateText(payload){
  const { mode, title, inputs } = payload;
  const lines = [];
  lines.push(`=== ${title} ===`);
  lines.push('');
  lines.push('Wejścia:');
  Object.entries(inputs).forEach(([k,v])=> lines.push(`- ${k}: ${v}`));
  lines.push('');
  lines.push('Plan (przykładowy szkic):');
  if(mode==='A'){
    for(let w=1; w<=12; w++){
      lines.push(`Tydzień ${w}: siła (FBW), bieg easy, akcesoria core, deload co 4 tygodnie.`);
    }
  }else{
    for(let w=1; w<=4; w++){
      lines.push(`Tydzień ${w}: rozkład A/B/C z 24–48h przerwy między bodźcami, priorytet: ${inputs.prio1 || '—'}.`);
    }
  }
  lines.push('');
  lines.push('Uwaga: To nie jest porada medyczna. Dostosuj do swoich możliwości.');
  return { planText: lines.join('\n'), planName: title };
}

/* ---------- Generowanie PDF (jsPDF) — PODMIANA ---------- */
async function makePdf(planText, planName){
  // Upewnij się, że jsPDF jest załadowany; jeśli nie, doładuj z zapasowego CDN
  async function ensureJsPDF(){
    if (window.jspdf?.jsPDF || window.jsPDF) return;
    await new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
      s.crossOrigin = 'anonymous';
      s.onload = resolve;
      s.onerror = ()=>reject(new Error('Nie udało się załadować jsPDF'));
      document.head.appendChild(s);
    });
  }

  await ensureJsPDF();
  const JsPDF = window.jspdf?.jsPDF || window.jsPDF;
  if (!JsPDF) throw new Error('jsPDF niedostępny');

  const doc = new JsPDF({ unit:'pt', format:'a4' });
  const margin = 48, width = 595.28 - margin*2; // A4 width pt
  const lineH = 16;
  const lines = doc.splitTextToSize(planText, width);
  let y = margin;
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text(planName, margin, y); y += 18;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  lines.forEach(t=>{
    if(y > 842 - margin){ doc.addPage(); y = margin; }
    doc.text(t, margin, y);
    y += lineH;
  });
  const blob = doc.output('blob');
  const url = URL.createObjectURL(blob);
  return { blob, url };
}

/* ---------- Integracja przycisku „Wygeneruj plan” ---------- */
const genBtn = document.getElementById('genBtn');
const dlBtn  = document.getElementById('dlBtn');

genBtn.addEventListener('click', async ()=>{
  try{
    genBtn.disabled = true; genBtn.textContent = 'Generowanie…';
    dlBtn.style.display='none'; dlBtn.removeAttribute('href');

    const payload = buildPayload();

    // 1) tu docelowo backend (jeśli masz funkcję generate-plan)
    // const { planText, planName } = await callBackendGenerate(payload);

    // 2) fallback lokalny:
    const { planText, planName } = localGenerateText(payload);

    // 3) PDF
    const { blob, url } = await makePdf(planText, planName);
    dlBtn.href = url; dlBtn.style.display='inline-flex';

    // 4) e-mail (Netlify Function – jeśli jej nie masz, można zakomentować linię poniżej)
    await window.hpOnPlanReady(blob, planName);

    genBtn.textContent = 'Gotowe ✓';
  }catch(e){
    console.error(e);
    alert('Nie udało się wygenerować planu.');
    genBtn.textContent = 'Wygeneruj plan';
  }finally{
    genBtn.disabled = false;
  }
});

/* ---------- RESEND: helpery + hook do wywołania po PDF ---------- */
function blobToBase64(blob){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(String(r.result).split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

async function sendPlanByEmail(pdfBlob, planName){
  try {
    const to = localStorage.getItem('hp_email');
    if(!to){ console.warn('Brak e-maila w localStorage (hp_email).'); return; }

    const b64 = pdfBlob ? await blobToBase64(pdfBlob) : null;

    const resp = await fetch('/.netlify/functions/send-email', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        to,
        subject: planName || 'Twój plan treningowy',
        html: '<p>W załączniku Twój plan (PDF). Dziękujemy za skorzystanie z HybridPlanner.</p>',
        attachmentBase64: b64,
        filename: 'plan.pdf'
      })
    });

    if(!resp.ok){
      const t = await resp.text();
      console.error('Resend error:', t);
      alert('Nie udało się wysłać e-maila. Spróbuj ponownie.');
      return;
    }
  } catch(e){
    console.error(e);
  }
}

window.hpOnPlanReady = async function(pdfBlob, planName){
  try { await sendPlanByEmail(pdfBlob, planName); }
  catch(e){ console.error(e); }
};

/* ---------- UX: automatyczne zaznaczenie trybu z hash ---------- */
window.addEventListener('hashchange', ()=>{
  if(/plan=B/i.test(location.hash)) showB();
  if(/plan=A/i.test(location.hash)) showA();
});
</script>
</body>
</html>
