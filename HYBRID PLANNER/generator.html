<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF; --beige:#8D8C87;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 34px/1.2 Poppins;margin:0 0 8px}
h2{font:700 22px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}
.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{background:#111;color:#fff;border:1px solid #333;padding:6px 10px;border-radius:10px;font:600 12px/1 Inter;text-decoration:none}
.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], input[type="email"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}
.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
.banner{display:flex;gap:10px;align-items:center;background:#112416;border:1px solid #1f4d2a;color:#cfead7;border-radius:12px;padding:10px 12px;margin:0 0 12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}
.hidden{display:none!important}
@media (max-width:700px){ .grid-2{grid-template-columns:1fr} }

/* Modal e-mail po płatności */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000}
.modal{background:#fff;color:#111;border-radius:16px;padding:22px;max-width:420px;width:92%;box-shadow:0 10px 40px rgba(0,0,0,.35)}
.modal h3{margin:0 0 8px}
.modal .row{margin:8px 0}
.modal .actions{margin-top:10px}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
  </div>

  <!-- GATE: pokazuje się przed opłaceniem -->
  <div id="purchaseGate" class="card">
    <h1 id="gateTitle">Dostęp do generatora</h1>
    <p id="gateDesc" style="margin:6px 0 14px;color:#C9C7C2">
      Aby wypełnić krótką ankietę i otrzymać plan (Excel) na e-mail, najpierw opłać dostęp.
    </p>
    <div class="actions">
      <button id="payBtn" class="btn btn-brown">Przejdź do płatności — 9,99&nbsp;zł</button>
    </div>
    <div class="notice">
      <small id="whoLbl_gate">Plan zostanie wysłany na e-mail: <strong id="who_gate"></strong></small>
      <small id="rodoLbl_gate">To nie jest porada medyczna.</small>
    </div>
  </div>

  <!-- FORM: pojawia się dopiero po opłaceniu -->
  <div id="formSection" class="card hidden">
    <div id="paidBanner" class="banner"><strong id="paidOk">Płatność potwierdzona.</strong> <span id="paidNext">Wypełnij ankietę, a my wygenerujemy plan.</span></div>

    <h1 id="title">Generator planów</h1>
    <p id="subtitle" style="margin:6px 0 14px;color:#C9C7C2">
      Wybierz odpowiedzi i kliknij <strong>Wygeneruj plan</strong>. Gotowy plik (Excel) wyślemy na Twój e-mail.
    </p>

    <h2 id="hA">Plan — pytania (5)</h2>
    <div class="grid-2">
      <div class="row">
        <label id="a1lbl">Ile razy w tygodniu chciałbyś/chciałabyś ćwiczyć?</label>
        <input id="a1" type="number" min="1" max="14" value="3">
      </div>
      <div class="row">
        <label id="a2lbl">Jaki jest twój główny cel?</label>
        <input id="a2" type="text" placeholder="np. zwiększyć siłę / redukcja tkanki tłuszczowej">
      </div>
      <div class="row">
        <label id="a3lbl">Jaki jest twój poziom aktywności fizycznej?</label>
        <select id="a3">
          <option>Zaawansowany</option>
          <option>Średniozaawansowany</option>
          <option>Początkujący</option>
        </select>
      </div>
      <div class="row">
        <label id="a4lbl">Do jakiego sprzętu treningowego masz dostęp?</label>
        <input id="a4" type="text" placeholder="np. siłownia pełna / hantle + drążek / dom">
      </div>
      <div class="row">
        <label id="a5lbl">Płeć</label>
        <select id="a5">
          <option value="Mężczyzna">Mężczyzna</option>
          <option value="Kobieta">Kobieta</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <div class="actions">
      <button id="genBtn" class="btn btn-brown">Wygeneruj plan</button>
      <a id="dlBtn" class="btn btn-ghost" href="#" download="Plan Treningowy.xlsx" style="display:none">Pobierz Excel</a>
    </div>

    <div class="notice">
      <small id="whoLbl">Plan zostanie wysłany na e-mail: <strong id="who"></strong></small>
      <small id="rodoLbl">To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<!-- Modal e-mail (pokazywany PO płatności, jeżeli brak e-maila) -->
<div id="emailModal" class="modal-backdrop" aria-modal="true" role="dialog">
  <div class="modal">
    <h3 id="mTitle">Podaj e-mail, aby wysłać plan</h3>
    <div class="row">
      <label id="mLabel" for="gateEmail">Twój e-mail</label>
      <input id="gateEmail" type="email" placeholder="np. imie@domena.com" autocomplete="email" required>
    </div>
    <div class="row" style="display:flex;align-items:flex-start;gap:10px">
      <input id="gateConsent" type="checkbox" required>
      <label id="mConsent" for="gateConsent" style="margin:0">Wyrażam zgodę na przetwarzanie moich danych osobowych.</label>
    </div>
    <div class="actions">
      <button id="gateConfirm" class="btn btn-brown" type="button">Kontynuuj</button>
      <button id="gateClose" class="btn btn-ghost" type="button">Anuluj</button>
    </div>
    <p id="gateError" style="color:#b00020;margin-top:10px;display:none">Podaj poprawny e-mail i zaznacz zgodę.</p>
  </div>
</div>

<script>
/* ---------- Endpoints ---------- */
const HP = {
  generate: '/.netlify/functions/generate-plan',
  sendEmail: '/.netlify/functions/send-email',
  checkoutPrimary:  '/.netlify/functions/create-checkout-session',
  checkoutFallback: '/.netlify/functions/create-checkout',
  verifySession: '/.netlify/functions/verify-session' // opcjonalne
};

/* ---------- helpers ---------- */
function qs(id){ return document.getElementById(id); }
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function setWho(email){
  (qs('who')||{}).textContent = email || '—';
  (qs('who_gate')||{}).textContent = email || '—';
}
function validEmail(v){ return /^[^\s@]+@[^\s@]+$/.test(v) && /\.[^\s@]{2,}$/.test(v); }

/* ---------- e-mail w UI (bez wymuszania przed płatnością) ---------- */
(function hydrateEmail(){
  setWho(localStorage.getItem('hp_email') || '');
})();

/* ---------- PŁATNOŚĆ – stan ---------- */
function isPaid(){
  const p = new URLSearchParams(location.search);
  if (p.get('checkout') === 'success') return true;
  if (p.get('session_id')) return true; // po nowym success_url
  return localStorage.getItem('hp_paid_ai') === '1';
}
function markPaid(){ localStorage.setItem('hp_paid_ai','1'); }

/* ---------- payload do generatora ---------- */
function buildPayload(){
  return {
    type: 'A',
    lang: (document.documentElement.lang || 'pl'),
    inputs: {
      sessionsPerWeek: Number(qs('a1').value || 0),
      goal: qs('a2').value.trim(),
      level: qs('a3').value,
      equipment: qs('a4').value.trim(),
      gender: qs('a5').value
    }
  };
}

/* ---------- backend: generate & e-mail ---------- */
async function callBackendForXlsx(payload){
  const res = await fetch(HP.generate, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const text = await res.text();
  let data = null; try { data = JSON.parse(text) } catch {}
  if (!res.ok || !data) throw new Error(`generate-plan ${res.status}: ${text.slice(0,300)}`);
  if (data.ok === false) throw new Error(data.error || data.details || 'Błąd backendu');
  const base64 = data.fileBase64 || data.xlsxBase64;
  const filename = data.filename || data.xlsxFilename || 'Plan Treningowy.xlsx';
  if (!base64) throw new Error('Brak pliku XLSX w odpowiedzi');
  return { xlsxBase64: base64, xlsxFilename: filename };
}

async function sendPlanByEmail(base64, filename){
  const to = localStorage.getItem('hp_email') || '';
  if(!to) return;
  const resp = await fetch(HP.sendEmail, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      to,
      subject: 'Twój plan treningowy',
      html: '<p>W załączniku Twój plan (XLSX). Dziękujemy za skorzystanie z HybridPlanner.</p>',
      attachmentBase64: base64,
      filename: filename || 'Plan Treningowy.xlsx'
    })
  });
  if(!resp.ok){ console.warn('send-email error:', await resp.text()); }
}

/* ---------- Stripe Checkout ---------- */
async function tryCreateCheckout(endpoint, payload){
  const r = await fetch(endpoint, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const txt = await r.text();
  let data = null; try { data = JSON.parse(txt) } catch {}
  if(!r.ok || !data?.url) throw new Error((data && (data.error||data.details)) || txt || 'checkout failed');
  return data.url;
}

async function createCheckout(){
  const email = localStorage.getItem('hp_email') || '';
  // Pozostawiamy success/cancel po stronie backendu (może wstawić session_id={CHECKOUT_SESSION_ID})
  const payload = { email };
  try { return await tryCreateCheckout(HP.checkoutPrimary, payload); }
  catch { return await tryCreateCheckout(HP.checkoutFallback, payload); }
}

/* ---------- Opcjonalna weryfikacja płatności ---------- */
async function verifyPaidIfPossible(){
  const p = new URLSearchParams(location.search);
  const sessionId = p.get('session_id');
  if(!sessionId) return true; // brak – zakładamy success z query 'checkout=success'
  try{
    const r = await fetch(HP.verifySession, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ session_id: sessionId })
    });
    if(!r.ok) throw 0;
    const data = await r.json();
    return !!data?.paid;
  }catch{ return true; } // łagodne domyślnie „true”, jeśli brak funkcji
}

/* ---------- Elementy ---------- */
const payBtn = qs('payBtn');
const genBtn = qs('genBtn');
const dlBtn  = qs('dlBtn');
const purchaseGate = qs('purchaseGate');
const formSection  = qs('formSection');

/* ---------- Modal e-mail ---------- */
const modal = qs('emailModal');
const mClose = qs('gateClose');
const mConfirm = qs('gateConfirm');
const mEmail = qs('gateEmail');
const mConsent = qs('gateConsent');
const mError = qs('gateError');
function openEmailModal(){ modal.style.display='flex'; mEmail.focus(); }
function closeEmailModal(){ modal.style.display='none'; }
mClose.addEventListener('click', closeEmailModal);
mConfirm.addEventListener('click', ()=>{
  mError.style.display='none';
  const v = (mEmail.value||'').trim();
  if(!validEmail(v) || !mConsent.checked){ mError.style.display='block'; return; }
  localStorage.setItem('hp_email', v);
  localStorage.setItem('hp_consent','1');
  setWho(v);
  closeEmailModal();
});

/* Upewnij się, że mamy e-mail (po płatności przed ankietą/generowaniem) */
async function ensureEmail(){
  const mail = localStorage.getItem('hp_email') || '';
  if(mail) return true;
  openEmailModal();
  return new Promise(resolve=>{
    const onClose = ()=>{ modal.removeEventListener('click', backdropHandler); resolve(!!localStorage.getItem('hp_email')); };
    function backdropHandler(e){ if(e.target===modal) closeEmailModal(); }
    modal.addEventListener('click', backdropHandler);
    // mConfirm już zapisuje e-mail i zamyka modal
    const obs = new MutationObserver(()=>{
      if(modal.style.display==='none'){ obs.disconnect(); onClose(); }
    });
    obs.observe(modal, { attributes:true, attributeFilter:['style'] });
  });
}

/* ---------- Init: pokaż odpowiednią sekcję ---------- */
(async function initGate(){
  const p = new URLSearchParams(location.search);
  const status = p.get('checkout');
  const hasSessionParam = !!p.get('session_id');

  if (status === 'cancel'){ /* nic nie robimy – zostaje bramka */ }
  if (status === 'success' || hasSessionParam){
    const paidOk = await verifyPaidIfPossible();
    if(paidOk){
      markPaid();
      // sprzątamy query po potwierdzeniu
      history.replaceState({}, '', window.location.pathname);
    }
  }

  if (isPaid()){
    hide(purchaseGate);
    show(formSection);
    // jeśli nie mamy e-maila, poproś teraz:
    if(!(localStorage.getItem('hp_email') && localStorage.getItem('hp_consent'))){
      openEmailModal();
    }
  } else {
    show(purchaseGate);
    hide(formSection);
  }
})();

/* ---------- Actions ---------- */
if (payBtn){
  payBtn.addEventListener('click', async ()=>{
    try{
      payBtn.disabled = true; payBtn.textContent = 'Łączenie ze Stripe…';
      const checkoutUrl = await createCheckout();
      window.location.href = checkoutUrl;
    }catch(e){
      console.error(e);
      alert('Nie udało się rozpocząć płatności: ' + String(e.message || e));
    }finally{
      payBtn.disabled = false; payBtn.textContent = 'Przejdź do płatności — 9,99 zł';
    }
  });
}

if (genBtn){
  genBtn.addEventListener('click', async ()=>{
    try{
      if (!isPaid()){
        const checkoutUrl = await createCheckout();
        window.location.href = checkoutUrl;
        return;
      }
      const ok = await ensureEmail();
      if(!ok) return;

      genBtn.disabled = true; genBtn.textContent = 'Generowanie…';
      dlBtn.style.display='none'; dlBtn.removeAttribute('href');

      const payload = buildPayload();
      const { xlsxBase64, xlsxFilename } = await callBackendForXlsx(payload);

      const url = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + xlsxBase64;
      dlBtn.href = url; dlBtn.download = xlsxFilename || 'Plan Treningowy.xlsx';
      dlBtn.style.display='inline-flex';

      await sendPlanByEmail(xlsxBase64, xlsxFilename);
      genBtn.textContent = 'Gotowe ✓';
    }catch(e){
      console.error(e);
      alert('Nie udało się wygenerować planu: ' + String(e.message || e));
      genBtn.textContent = 'Wygeneruj plan';
    }finally{
      genBtn.disabled = false;
    }
  });
}

/* ---------- i18n ---------- */
(function () {
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const t = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  const toggleBtn = document.getElementById('langToggle');

  if (lang === 'en') {
    // Header
    t('backLbl','← Back');
    if (toggleBtn){ toggleBtn.href='?lang=pl'; toggleBtn.textContent='PL'; toggleBtn.setAttribute('aria-label','Polska wersja'); }
    document.documentElement.lang = 'en';

    // Gate
    t('gateTitle','Access to the generator');
    t('gateDesc','To fill out a short questionnaire and receive your plan (Excel) by e-mail, please complete the payment first.');
    t('payBtn','Go to payment — 9.99 PLN');
    t('whoLbl_gate','The plan will be sent to:');
    t('rodoLbl_gate','This is not medical advice.');

    // Form after payment
    t('paidOk','Payment confirmed.');
    t('paidNext','Fill in the questionnaire and we will generate your plan.');
    t('title','Plan generator');
    t('subtitle','Choose the answers and click Generate plan. We will send the Excel file to your e-mail.');
    t('hA','Plan — questions (5)');
    t('a1lbl','How many sessions per week would you like?');
    t('a2lbl','What is your main goal?');
    t('a3lbl','What is your training level?');
    t('a4lbl','What equipment do you have access to?');
    t('a5lbl','Gender');
    qs('genBtn') && (qs('genBtn').textContent = 'Generate plan');
    qs('dlBtn')  && (qs('dlBtn').textContent  = 'Download Excel');
    t('whoLbl','The plan will be sent to:');
    t('rodoLbl','This is not medical advice. Use at your own risk.');

    // Modal
    t('mTitle','Enter your e-mail to receive the plan');
    t('mLabel','Your e-mail');
    t('mConsent','I consent to the processing of my personal data.');
    qs('gateConfirm') && (qs('gateConfirm').textContent = 'Continue');
    qs('gateClose') && (qs('gateClose').textContent = 'Cancel');
    qs('gateError') && (qs('gateError').textContent = 'Enter a valid e-mail and tick the consent box.');

    localStorage.setItem('hp_lang','en');
  } else {
    // Header
    t('backLbl','← Wróć');
    if (toggleBtn){ toggleBtn.href='?lang=en'; toggleBtn.textContent='EN'; toggleBtn.setAttribute('aria-label','English version'); }
    document.documentElement.lang = 'pl';

    // Gate
    t('gateTitle','Dostęp do generatora');
    t('gateDesc','Aby wypełnić krótką ankietę i otrzymać plan (Excel) na e-mail, najpierw opłać dostęp.');
    t('payBtn','Przejdź do płatności — 9,99 zł');
    t('whoLbl_gate','Plan zostanie wysłany na e-mail:');
    t('rodoLbl_gate','To nie jest porada medyczna.');

    // Form
    t('paidOk','Płatność potwierdzona.');
    t('paidNext','Wypełnij ankietę, a my wygenerujemy plan.');
    t('title','Generator planów');
    t('subtitle','Wybierz odpowiedzi i kliknij Wygeneruj plan. Gotowy plik (Excel) wyślemy na Twój e-mail.');
    t('hA','Plan — pytania (5)');
    t('a1lbl','Ile razy w tygodniu chciałbyś/chciałabyś ćwiczyć?');
    t('a2lbl','Jaki jest twój główny cel?');
    t('a3lbl','Jaki jest twój poziom aktywności fizycznej?');
    t('a4lbl','Do jakiego sprzętu treningowego masz dostęp?');
    t('a5lbl','Płeć');
    qs('genBtn') && (qs('genBtn').textContent = 'Wygeneruj plan');
    qs('dlBtn')  && (qs('dlBtn').textContent  = 'Pobierz Excel');
    t('whoLbl','Plan zostanie wysłany na e-mail:');
    t('rodoLbl','To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.');

    // Modal
    t('mTitle','Podaj e-mail, aby wysłać plan');
    t('mLabel','Twój e-mail');
    t('mConsent','Wyrażam zgodę na przetwarzanie moich danych osobowych.');
    qs('gateConfirm') && (qs('gateConfirm').textContent = 'Kontynuuj');
    qs('gateClose') && (qs('gateClose').textContent = 'Anuluj');
    qs('gateError') && (qs('gateError').textContent = 'Podaj poprawny e-mail i zaznacz zgodę.');

    localStorage.setItem('hp_lang','pl');
  }
})();
</script>
</body>
</html>
