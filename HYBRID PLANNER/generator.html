<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF; --beige:#8D8C87;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 34px/1.2 Poppins;margin:0 0 8px}
h2{font:700 22px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}

.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{
  background:#111; color:#fff; border:1px solid #333;
  padding:6px 10px; border-radius:10px; font:600 12px/1 Inter; text-decoration:none;
}

.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], input[type="email"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.badge{display:inline-block;background:#1e1e1e;border:1px solid #303030;border-radius:999px;padding:6px 10px;font:600 12px/1 Inter;margin-right:8px;margin-bottom:8px}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}

.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
  </div>

  <div class="card">
    <h1 id="title">Generator planów</h1>
    <p id="subtitle" style="margin:6px 0 14px;color:#C9C7C2">Wybierz tryb, odpowiedz na pytania i wygeneruj plan. PDF zostanie wysłany na Twój e-mail.</p>

    <!-- wybór trybu -->
    <div class="row">
      <label id="modeLbl">Tryb generatora</label>
      <div class="actions">
        <button class="btn btn-ghost" id="btnA">Plan A — 12 tygodni</button>
        <button class="btn btn-ghost" id="btnB">Plan B — Hybrydowy tydzień (4 tygodnie)</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- PLAN A — 5 pytań -->
    <section id="formA" style="display:none">
      <h2 id="hA">Plan A — pytania (5)</h2>
      <div class="grid-2">
        <div class="row">
          <label id="a1lbl">Ile razy w tygodniu chciałbyś/chciałabyś ćwiczyć?</label>
          <input id="a1" type="number" min="1" max="14" value="4">
        </div>
        <div class="row">
          <label id="a2lbl">Jaki jest twój główny cel?</label>
          <input id="a2" type="text" placeholder="np. zwiększyć siłę / redukcja tkanki tłuszczowej">
        </div>
        <div class="row">
          <label id="a3lbl">Jaki jest twój poziom aktywności fizycznej?</label>
          <select id="a3">
            <option>Zaawansowany</option>
            <option>Średniozaawansowany</option>
            <option>Początkujący</option>
          </select>
        </div>
        <div class="row">
          <label id="a4lbl">Do jakiego sprzętu treningowego masz dostęp?</label>
          <input id="a4" type="text" placeholder="np. siłownia pełna / hantle + drążek / dom">
        </div>
        <div class="row">
          <label id="a5lbl">Czy chcesz trenować konkretnym schematem czy mam dopasować?</label>
          <select id="a5">
            <option>FBW</option>
            <option>PPL</option>
            <option>Arnold Split</option>
            <option>Upper Lower</option>
            <option>Dopasowany do twoich potrzeb</option>
          </select>
        </div>
      </div>
    </section>

    <!-- PLAN B (jak było) -->
    <section id="formB" style="display:none">
      <h2 id="hB">Plan B — pytania (10)</h2>
      <div class="grid-2">
        <div class="row"><label id="b1lbl">Dyscypliny (wybierz z listy lub wpisz)</label>
          <input id="b1" type="text" placeholder="np. siłownia, bieganie, wspinaczka">
          <small id="b1hint">Szybki wybór poniżej — kliknij, by dodać:</small>
          <div id="chips" style="margin-top:8px"></div>
        </div>
        <div class="row"><label id="b2lbl">Priorytet 1</label><input id="b2" type="text" placeholder="np. bieg 5 km / siła nóg"></div>
        <div class="row"><label id="b3lbl">Priorytet 2</label><input id="b3" type="text" placeholder="opcjonalnie"></div>
        <div class="row"><label id="b4lbl">Liczba jednostek/tydzień</label><input id="b4" type="number" min="1" max="14" value="4"></div>
        <div class="row"><label id="b5lbl">Dostępne dni</label><input id="b5" type="text" placeholder="np. pn, śr, pt, sob"></div>
        <div class="row"><label id="b6lbl">Czas na jednostkę (min)</label><input id="b6" type="number" min="20" max="180" value="60"></div>
        <div class="row"><label id="b7lbl">Poziom</label>
          <select id="b7"><option>Początkujący</option><option>Średniozaawansowany</option><option>Zaawansowany</option></select>
        </div>
        <div class="row"><label id="b8lbl">Sprzęt</label><input id="b8" type="text" placeholder="np. siłownia / dom / ścianka"></div>
        <div class="row"><label id="b9lbl">Ograniczenia</label><input id="b9" type="text" placeholder="np. brak skoków / bez sprintów"></div>
        <div class="row"><label id="b10lbl">Uwagi</label><textarea id="b10" placeholder="dodatkowe informacje"></textarea></div>
      </div>
      <div class="hr"></div>
      <div>
        <label id="quickLbl">Szybki wybór (20 dyscyplin)</label>
        <div class="grid-3" id="discGrid" style="margin-top:8px"></div>
      </div>
    </section>

    <div class="hr"></div>

    <div class="actions">
      <button id="genBtn" class="btn btn-brown">Wygeneruj plan</button>
      <a id="dlBtn" class="btn btn-ghost" href="#" download="plan.pdf" style="display:none">Pobierz PDF</a>
      <!-- NOWE: przycisk XLSX -->
      <a id="dlXlsx" class="btn btn-ghost" href="#" download="plan.xlsx" style="display:none">Pobierz XLSX</a>
    </div>

    <div class="notice">
      <small id="whoLbl">Plan zostanie wysłany na e-mail: <strong id="who"></strong></small>
      <small id="rodoLbl">To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- NOWE: SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ---------- Bramka e-mail ---------- */
(function(){
  const mail = localStorage.getItem('hp_email');
  const consent = localStorage.getItem('hp_consent');
  if(!mail || !consent){ window.location.href = 'index.html'; }
  else { document.getElementById('who').textContent = mail; }
})();

/* ---------- I18N EN/PL ---------- */
(function(){
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
  const toggleBtn = document.getElementById('langToggle');

  if(lang==='en'){
    t('backLbl','← Back');
    t('title','Plan generator');
    t('subtitle','Choose mode, answer the questions, and generate the plan. The PDF will be emailed to you.');
    t('modeLbl','Generator mode');
    document.getElementById('btnA').textContent='Plan A — 12 weeks';
    document.getElementById('btnB').textContent='Plan B — Hybrid week (4 weeks)';

    // Plan A (5 questions)
    t('hA','Plan A — questions (5)');
    t('a1lbl','How many sessions per week would you like?');
    t('a2lbl','What is your main goal?');
    t('a3lbl','What is your activity/experience level?');
    document.querySelector('#a3 option[value="Zaawansowany"]').textContent='Advanced';
    document.querySelector('#a3 option[value="Średniozaawansowany"]').textContent='Intermediate';
    document.querySelector('#a3 option[value="Początkujący"]').textContent='Beginner';
    t('a4lbl','What equipment do you have access to?');
    t('a5lbl','Do you want a specific split or should I pick the best match?');
    const a5 = document.getElementById('a5');
    a5.options[0].text='FBW'; a5.options[1].text='PPL'; a5.options[2].text='Arnold Split'; a5.options[3].text='Upper Lower'; a5.options[4].text='Best match for your needs';

    // Plan B
    t('hB','Plan B — questions (10)');
    t('b1lbl','Disciplines (pick or type)'); t('b1hint','Quick pick below — click to add:');
    t('b2lbl','Priority 1'); t('b3lbl','Priority 2');
    t('b4lbl','Sessions/week'); t('b5lbl','Available days');
    t('b6lbl','Time per session (min)'); t('b7lbl','Level');
    t('b8lbl','Equipment'); t('b9lbl','Limitations'); t('b10lbl','Notes');
    t('quickLbl','Quick pick (20 disciplines)');

    document.getElementById('genBtn').textContent='Generate plan';
    document.getElementById('dlBtn').textContent='Download PDF';
    t('whoLbl','The plan will be sent to: ');
    t('rodoLbl','This is not medical advice. Use at your own risk.');

    localStorage.setItem('hp_lang','en');
    if(toggleBtn){ toggleBtn.href='?lang=pl'; toggleBtn.textContent='PL'; toggleBtn.setAttribute('aria-label','Polish version'); }
  } else {
    localStorage.setItem('hp_lang','pl');
    if(toggleBtn){ toggleBtn.href='?lang=en'; toggleBtn.textContent='EN'; toggleBtn.setAttribute('aria-label','English version'); }
  }
})();

/* ---------- Lista 20 dyscyplin ---------- */
const DISC = [
  'Siłownia','Bieganie','Wspinaczka','Jazda na rowerze','Pływanie',
  'Joga','Mobility','HIIT','Cross-training','Trening obwodowy',
  'Wioślarz','Sztangi','Kettlebell','Trening kalisteniczny','Pilates',
  'Boks','MMA','Tenis','Badminton','Narciarstwo biegowe'
];
(function(){
  const grid = document.getElementById('discGrid');
  const chips = document.getElementById('chips');
  if(!grid) return;
  DISC.forEach(name=>{
    const b = document.createElement('button');
    b.type='button'; b.className='badge'; b.textContent=name;
    b.addEventListener('click', ()=>{
      const input = document.getElementById('b1');
      const cur = input.value.trim();
      const list = cur ? cur.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if(!list.includes(name)) list.push(name);
      input.value = list.join(', ');
      const c = document.createElement('span'); c.className='badge'; c.textContent=name;
      chips.appendChild(c);
    });
    grid.appendChild(b);
  });
})();

/* ---------- Przełączanie trybów ---------- */
const formA = document.getElementById('formA');
const formB = document.getElementById('formB');
const btnA  = document.getElementById('btnA');
const btnB  = document.getElementById('btnB');

function showA(){ formA.style.display='block'; formB.style.display='none'; btnA.classList.add('btn-brown'); btnB.classList.remove('btn-brown'); }
function showB(){ formA.style.display='none'; formB.style.display='block'; btnB.classList.add('btn-brown'); btnA.classList.remove('btn-brown'); }

btnA.addEventListener('click', showA);
btnB.addEventListener('click', showB);
(function(){
  const h = location.hash;
  if(h && /plan=B/i.test(h)) showB();
  else if(h && /plan=A|plan=BUNDLE/i.test(h)) showA();
  else showA();
})();

/* ---------- Payload z formularza ---------- */
function buildPayload(){
  const usingA = formA.style.display==='block';
  if(usingA){
    return {
      mode: 'A',
      title: 'Plan Treningowy',
      inputs: {
        sessionsPerWeek: Number(document.getElementById('a1').value || 0),
        goal: document.getElementById('a2').value.trim(),
        level: document.getElementById('a3').value,
        equipment: document.getElementById('a4').value.trim(),
        splitPreference: document.getElementById('a5').value
      }
    };
  } else {
    return {
      mode: 'B',
      title: 'Hybrydowy Plan Treningowy',
      inputs: {
        disciplines: document.getElementById('b1').value.trim(),
        prio1: document.getElementById('b2').value.trim(),
        prio2: document.getElementById('b3').value.trim(),
        sessionsPerWeek: Number(document.getElementById('b4').value || 0),
        days: document.getElementById('b5').value.trim(),
        minPerSession: Number(document.getElementById('b6').value || 0),
        level: document.getElementById('b7').value,
        equipment: document.getElementById('b8').value.trim(),
        limits: document.getElementById('b9').value.trim(),
        notes: document.getElementById('b10').value.trim(),
      }
    };
  }
}

/* ---------- ZAMIANA: PROMPT — 1 TYDZIEŃ + JSON ---------- */
function buildPrompt(payload, lang){
  const L = (lang || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const isEN = L === 'en';
  const A = payload.mode === 'A';
  const dayNamesPL = ['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'];
  const dayNamesEN = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const daysList = isEN ? dayNamesEN.join(', ') : dayNamesPL.join(', ');

  const header = A
    ? (isEN
      ? `ROLE: Experienced S&C coach. Create a detailed WEEKLY training plan (one-week template).`
      : `ROLA: Doświadczony trener S&C. Stwórz szczegółowy TYDZIEŃ planu (szablon jednego tygodnia).`)
    : (isEN
      ? `ROLE: Experienced S&C coach. Create a detailed 1-week HYBRID schedule.`
      : `ROLA: Doświadczony trener S&C. Stwórz szczegółowy HYBRYDOWY plan na 1 tydzień.`);

  const inputsBlock = Object.entries(payload.inputs).map(([k,v])=>`- ${k}: ${v ?? '—'}`).join('\n');

  const HARD_RULES_PL = `
FORMAT planu tygodniowego:
- zaplanuj dokładnie 7 dni (${daysList}); liczba DNI TRENINGOWYCH = "sessionsPerWeek" z formularza; pozostałe dni jako "Odpoczynek".
- każdy dzień treningowy ma mieć oznaczenie, który to dzień tygodnia.
- w dniu treningowym umieść 5–8 ćwiczeń.
- dobór ćwiczeń zgodny z cyklem dnia:
  • PULL → wyłącznie plecy, biceps, przedramię (+ ewentualnie brzuch)
  • PUSH → wyłącznie klatka, barki, triceps (+ brzuch)
  • UPPER → klatka, plecy, barki, biceps, triceps, brzuch
  • LOWER/LEGS → przednia taśma KD, tylna taśma KD, łydki
  • FBW → klatka, plecy, barki, biceps, triceps, brzuch, tylna i przednia taśma KD
- każde ćwiczenie MUSI mieć: "sets" (3–4), "reps" (8–12), "rest_min" (czas przerwy w minutach), "rir" (np. X), "rpe" (8–9), "tempo" (np. X), "comment" (może być pusty).
- w dniu treningowym:
  • duże partie (klatka, plecy) → 3 ćwiczenia,
  • mniejsze (biceps, triceps, barki, przednia/tylna taśma KD) → po 2 ćwiczenia,
  • jedno ćwiczenie dodatkowe: brzuch / przedramię / łydki.
- 24–48 h przerwy między kolejnymi bodźcami dla tych samych grup mięśniowych.
- używaj WYŁĄCZNIE listy ćwiczeń z briefu użytkownika.
- kolejność w dniu: najpierw duże → potem mniejsze → dodatkowe.
- rodzaj planu i split dopasuj do "splitPreference".
`.trim();

  const OUTPUT_INSTRUCTIONS = `
ZWRÓĆ DWA BLOKI:
1) JSON w bloku \`\`\`json ... \`\`\` o dokładnie takim schemacie:
{
  "meta": {
    "language": "${isEN?'en':'pl'}",
    "sessionsPerWeek": <number>
  },
  "week": [
    {
      "weekday": "${isEN?'Monday':'Poniedziałek'}",
      "type": "TRAINING" | "REST",
      "label": "Upper | Lower | Push | Pull | Legs | FBW | ${isEN?'Rest':'Odpoczynek'}",
      "exercises": [
        {
          "name": "Flat bench press",
          "sets": 3,
          "reps": "8-12",
          "rest_min": 2,
          "rir": "X",
          "rpe": 8,
          "tempo": "X",
          "comment": ""
        }
      ]
    }
  ]
}
2) Po JSON krótki opis tekstowy tygodnia (plain text), zakończ zdaniem: "${isEN?'This is not medical advice.':'To nie jest porada medyczna.'}"
`.trim();

  const PLAN_REQUEST = A
    ? (isEN ? `
Make a ONE-WEEK template. Number of TRAINING days must equal "sessionsPerWeek".
Pick the split from "splitPreference" (FBW / PPL / Arnold / Upper–Lower / best match).
Keep 24–48h between stimuli of the same groups. Use only allowed exercises and required order.`
       : `
Ułóż SZABLON JEDNEGO TYGODNIA. Liczba DNI TRENINGOWYCH = "sessionsPerWeek".
Wybierz split z "splitPreference" (FBW / PPL / Arnold / Upper–Lower / dopasowany).
Zachowaj 24–48 h przerw. Używaj tylko dozwolonych ćwiczeń i wymaganej kolejności.`)
    : (isEN ? `
Create a ONE-WEEK hybrid schedule. Mark rest vs training (training count = "sessionsPerWeek").
Assign each training day to listed disciplines; for "gym" label structure (Upper/Lower/FBW) and follow the same rules.`
       : `
Stwórz HYBRYDOWY tydzień. Zaznacz dni treningowe (ich liczba = "sessionsPerWeek") i odpoczynku.
Gdy jest siłownia – nazwij strukturę dnia (Upper/Lower/FBW) i stosuj te same reguły.`);

  return [
    header,'',
    (isEN?'INPUTS:':'DANE WEJŚCIOWE:'), inputsBlock,'',
    HARD_RULES_PL,'',
    OUTPUT_INSTRUCTIONS,'',
    PLAN_REQUEST
  ].join('\n');
}

/* ---------- PDF ---------- */
async function makePdf(planText, planName){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const margin = 48, width = 595.28 - margin*2;
  const lineH = 16;
  const lines = doc.splitTextToSize(planText, width);
  let y = margin;
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text(planName, margin, y); y += 18;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  lines.forEach(t=>{
    if(y > 842 - margin){ doc.addPage(); y = margin; }
    doc.text(t, margin, y);
    y += lineH;
  });
  const blob = doc.output('blob');
  const url = URL.createObjectURL(blob);
  return { blob, url };
}

/* ---------- NOWE: parser JSON i XLSX ---------- */
function extractPlanJson(planText){
  const m = planText.match(/```json\s*([\s\S]*?)```/i);
  if(!m) return null;
  try { return JSON.parse(m[1]); } catch(e){ console.warn('JSON parse error', e); return null; }
}
function buildXlsxFromPlan(planJson, planName){
  if(!planJson || !planJson.week) return null;
  const wb = XLSX.utils.book_new();
  const HEAD = ['ĆWICZENIE','SERIE','POWTÓRZENIA','PRZERWA','RIR','RPE','TEMPO','KOMENTARZ / WYKONANIE','NUMER SERII'];

  planJson.week.forEach(day=>{
    const isRest = (day.type||'').toUpperCase()==='REST' || /odp/i.test(day.label||'');
    const title = (day.weekday || 'Dzień').slice(0,20) + (day.label ? ` — ${day.label}` : '');
    if(isRest){
      const ws = XLSX.utils.aoa_to_sheet([[title],[ 'Odpoczynek' ]]);
      XLSX.utils.book_append_sheet(wb, ws, day.weekday?.substring(0,31) || 'REST');
      return;
    }
    const rows = [HEAD];
    (day.exercises||[]).forEach(ex=>{
      rows.push([
        ex.name || '',
        ex.sets ?? '',
        ex.reps || '8-12',
        (ex.rest_min!=null? `${ex.rest_min}min` : ''),
        ex.rir || 'X',
        ex.rpe ?? '',
        ex.tempo || 'X',
        ex.comment || '',
        ''
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [
      {wch:34},{wch:6},{wch:12},{wch:10},{wch:6},{wch:6},{wch:8},{wch:24},{wch:10}
    ];
    XLSX.utils.book_append_sheet(wb, ws, (day.weekday||'Dzien').substring(0,31));
  });

  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const url = URL.createObjectURL(blob);
  return { blob, url, filename: (planName||'plan') + '.xlsx' };
}

/* ---------- ZAMIANA: wysyłka e-mail (dowolny plik) ---------- */
async function sendPlanByEmail(fileBlob, planName, filename){
  try {
    const to = localStorage.getItem('hp_email');
    if(!to){ console.warn('Brak e-maila w localStorage (hp_email).'); return; }

    function blobToBase64(b){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result).split(',')[1]);
        r.onerror = reject;
        r.readAsDataURL(b);
      });
    }
    const b64 = fileBlob ? await blobToBase64(fileBlob) : null;

    const resp = await fetch('/.netlify/functions/send-email', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        to,
        subject: planName || 'Twój plan treningowy',
        html: '<p>W załączniku Twój plan. Dziękujemy za skorzystanie z HybridPlanner.</p>',
        attachmentBase64: b64,
        filename: filename || 'plan.xlsx'
      })
    });

    if(!resp.ok){
      const t = await resp.text();
      console.error('Resend error:', t);
      alert('Nie udało się wysłać e-maila. Spróbuj ponownie.');
    }
  } catch(e){
    console.error(e);
    alert('Nie udało się wysłać e-maila (wyjątek).');
  }
}
window.hpOnPlanReady = async function(fileBlob, planName, filename){
  try { await sendPlanByEmail(fileBlob, planName, filename); }
  catch(e){ console.error(e); }
};

/* ---------- (Opcjonalnie) backend OpenAI ---------- */
/*
async function callBackendGenerateWithPrompt(payload){
  const prompt = buildPrompt(payload, localStorage.getItem('hp_lang')||'pl');
  const res = await fetch('/.netlify/functions/generate-plan', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ prompt, mode: payload.mode, inputs: payload.inputs })
  });
  if(!res.ok) throw new Error(await res.text());
  return await res.json(); // { planText: "...", planName: "..." }
}
*/

/* ---------- Generowanie (XLSX z JSON + PDF opis) ---------- */
const genBtn = document.getElementById('genBtn');
const dlBtn  = document.getElementById('dlBtn');
genBtn.addEventListener('click', async ()=>{
  try{
    genBtn.disabled = true; genBtn.textContent = 'Generowanie…';
    dlBtn.style.display='none'; dlBtn.removeAttribute('href');
    const dlXlsx = document.getElementById('dlXlsx'); 
    if(dlXlsx){ dlXlsx.style.display='none'; dlXlsx.removeAttribute('href'); }

    const payload = buildPayload();

    // 1) (Jeśli masz backend) odkomentuj:
    // const { planText, planName } = await callBackendGenerateWithPrompt(payload);

    // 2) Fallback DEMO bez backendu – generujemy prompt + przykładowy JSON,
    //    żeby interfejs działał od razu. Backend nadpisze to realną odpowiedzią.
    const { planText, planName } = (function demo(){
      const txt = buildPrompt(payload, localStorage.getItem('hp_lang')||'pl');
      const sampleJson = {
        meta:{language:'pl', sessionsPerWeek: payload.inputs.sessionsPerWeek||3},
        week:[
          { weekday:'Poniedziałek', type:'TRAINING', label:'PUSH', exercises:[
            {name:'Flat bench press', sets:4, reps:'8-12', rest_min:3, rir:'X', rpe:9, tempo:'X', comment:''},
            {name:'Incline bench press', sets:3, reps:'8-12', rest_min:3, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Overhead press', sets:3, reps:'8-12', rest_min:3, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Triceps extension', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Lateral raise', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Hanging knee raises', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''}
          ]},
          { weekday:'Wtorek', type:'REST', label:'Odpoczynek', exercises:[]},
          { weekday:'Środa', type:'TRAINING', label:'PULL', exercises:[
            {name:'Lat pulldown', sets:4, reps:'8-12', rest_min:3, rir:'X', rpe:9, tempo:'X', comment:''},
            {name:'Horizontal row 45*', sets:3, reps:'8-12', rest_min:3, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Bent over row', sets:3, reps:'8-12', rest_min:3, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Biceps curl', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Hammer curl', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Forearm curl', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''}
          ]},
          { weekday:'Czwartek', type:'REST', label:'Odpoczynek', exercises:[]},
          { weekday:'Piątek', type:'TRAINING', label:'LEGS', exercises:[
            {name:'Squat', sets:4, reps:'8-12', rest_min:3, rir:'X', rpe:9, tempo:'X', comment:''},
            {name:'Leg extension', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Deadlift', sets:3, reps:'8-12', rest_min:3, rir:'X', rpe:9, tempo:'X', comment:''},
            {name:'Leg curl', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''},
            {name:'Calf raises', sets:3, reps:'8-12', rest_min:2, rir:'X', rpe:8, tempo:'X', comment:''}
          ]},
          { weekday:'Sobota', type:'REST', label:'Odpoczynek', exercises:[]},
          { weekday:'Niedziela', type:'REST', label:'Odpoczynek', exercises:[]}
        ]
      };
      const combined = `\`\`\`json\n${JSON.stringify(sampleJson,null,2)}\n\`\`\`\n\nTo nie jest porada medyczna.`;
      return { planText: combined, planName: 'Plan Treningowy' };
    })();

    // 3) JSON → XLSX
    const planJson = extractPlanJson(planText);
    let xlsxOut = null;
    if(planJson){
      xlsxOut = buildXlsxFromPlan(planJson, planName);
      if(xlsxOut){
        const dlXlsx = document.getElementById('dlXlsx');
        if(dlXlsx){ dlXlsx.href = xlsxOut.url; dlXlsx.download = xlsxOut.filename; dlXlsx.style.display='inline-flex'; }
        await window.hpOnPlanReady(xlsxOut.blob, planName, xlsxOut.filename);
      }
    }

    // 4) PDF z opisem (bez bloku JSON w treści)
    const { blob:pdfBlob, url:pdfUrl } = await makePdf(planText.replace(/```json[\s\S]*?```/g,''), planName);
    dlBtn.href = pdfUrl; dlBtn.style.display='inline-flex';

    genBtn.textContent = 'Gotowe ✓';
  }catch(e){
    console.error(e);
    alert('Nie udało się wygenerować planu.');
    genBtn.textContent = 'Wygeneruj plan';
  }finally{
    genBtn.disabled = false;
  }
});

/* ---------- Hash → przełącznik ---------- */
window.addEventListener('hashchange', ()=>{
  if(/plan=B/i.test(location.hash)) showB();
  if(/plan=A/i.test(location.hash)) showA();
});
</script>
</body>
</html>
