<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF; --beige:#8D8C87;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 34px/1.2 Poppins;margin:0 0 8px}
h2{font:700 22px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}

.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{background:#111;color:#fff;border:1px solid #333;padding:6px 10px;border-radius:10px;font:600 12px/1 Inter;text-decoration:none;}

.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], input[type="email"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.badge{display:inline-block;background:#1e1e1e;border:1px solid #303030;border-radius:999px;padding:6px 10px;font:600 12px/1 Inter;margin-right:8px;margin-bottom:8px;color:#fff;}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}

.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
  </div>

  <div class="card">
    <h1 id="title">Generator planów</h1>
    <p id="subtitle" style="margin:6px 0 14px;color:#C9C7C2">Wybierz tryb, odpowiedz na pytania i wygeneruj plan. <strong>Plik Excel</strong> zostanie wysłany na Twój e-mail.</p>

    <!-- wybór trybu -->
    <div class="row">
      <label id="modeLbl">Tryb generatora</label>
      <div class="actions">
        <button class="btn btn-ghost" id="btnA">Plan A — 12 tygodni</button>
        <button class="btn btn-ghost" id="btnB">Plan B — Hybrydowy tydzień (4 tygodnie)</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- PLAN A — 5 pytań (zamiana #5 na PŁEĆ) -->
    <section id="formA" style="display:none">
      <h2 id="hA">Plan A — pytania (5)</h2>
      <div class="grid-2">
        <div class="row">
          <label id="a1lbl">Ile razy w tygodniu chciałbyś/chciałabyś ćwiczyć?</label>
          <input id="a1" type="number" min="1" max="14" value="4">
        </div>
        <div class="row">
          <label id="a2lbl">Jaki jest twój główny cel?</label>
          <input id="a2" type="text" placeholder="np. zwiększyć siłę / redukcja tkanki tłuszczowej">
        </div>
        <div class="row">
          <label id="a3lbl">Jaki jest twój poziom aktywności fizycznej?</label>
          <select id="a3">
            <option>Zaawansowany</option>
            <option>Średniozaawansowany</option>
            <option>Początkujący</option>
          </select>
        </div>
        <div class="row">
          <label id="a4lbl">Do jakiego sprzętu treningowego masz dostęp?</label>
          <input id="a4" type="text" placeholder="np. siłownia pełna / hantle + drążek / dom">
        </div>
        <div class="row">
          <label id="a5lbl">Płeć</label>
          <select id="a5">
            <option value="Mężczyzna">Mężczyzna</option>
            <option value="Kobieta">Kobieta</option>
          </select>
        </div>
      </div>
    </section>

    <!-- PLAN B (pozostawione bez zmian) -->
    <section id="formB" style="display:none">
      <h2 id="hB">Plan B — pytania (10)</h2>
      <div class="grid-2">
        <div class="row"><label id="b1lbl">Dyscypliny (wybierz z listy lub wpisz)</label>
          <input id="b1" type="text" placeholder="np. siłownia, bieganie, wspinaczka">
          <small id="b1hint">Szybki wybór poniżej — kliknij, by dodać:</small>
          <div id="chips" style="margin-top:8px"></div>
        </div>
        <div class="row"><label id="b2lbl">Priorytet 1</label><input id="b2" type="text" placeholder="np. bieg 5 km / siła nóg"></div>
        <div class="row"><label id="b3lbl">Priorytet 2</label><input id="b3" type="text" placeholder="opcjonalnie"></div>
        <div class="row"><label id="b4lbl">Liczba jednostek/tydzień</label><input id="b4" type="number" min="1" max="14" value="4"></div>
        <div class="row"><label id="b5lbl">Dostępne dni</label><input id="b5" type="text" placeholder="np. pn, śr, pt, sob"></div>
        <div class="row"><label id="b6lbl">Czas na jednostkę (min)</label><input id="b6" type="number" min="20" max="180" value="60"></div>
        <div class="row"><label id="b7lbl">Poziom</label>
          <select id="b7"><option>Początkujący</option><option>Średniozaawansowany</option><option>Zaawansowany</option></select>
        </div>
        <div class="row"><label id="b8lbl">Sprzęt</label><input id="b8" type="text" placeholder="np. siłownia / dom / ścianka"></div>
        <div class="row"><label id="b9lbl">Ograniczenia</label><input id="b9" type="text" placeholder="np. brak skoków / bez sprintów"></div>
        <div class="row"><label id="b10lbl">Uwagi</label><textarea id="b10" placeholder="dodatkowe informacje"></textarea></div>
      </div>
      <div class="hr"></div>
      <div>
        <label id="quickLbl">Szybki wybór (20 dyscyplin)</label>
        <div class="grid-3" id="discGrid" style="margin-top:8px"></div>
      </div>
    </section>

    <div class="hr"></div>

    <div class="actions">
      <button id="genBtn" class="btn btn-brown">Wygeneruj plan</button>
      <a id="dlBtn" class="btn btn-ghost" href="#" download="Plan_Treningowy.xlsx" style="display:none">Pobierz plik Excel</a>
    </div>

    <div class="notice">
      <small id="whoLbl">Plan zostanie wysłany na e-mail: <strong id="who"></strong></small>
      <small id="rodoLbl">To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<!-- XLSX (XlsxPopulate) -->
<script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>

<script>
/* ---------- KONFIG: Netlify Functions (Groq) ---------- */
window.HP_ORIGIN = location.origin; // działa z tgmproject.net i lokalnie
window.HP_ENDPOINTS = {
  generate: '/.netlify/functions/generate-plan',
  sendEmail: '/.netlify/functions/send-email'
};

/* ---------- Bramka e-mail ---------- */
(function(){
  const mail = localStorage.getItem('hp_email');
  const consent = localStorage.getItem('hp_consent');
  if(!mail || !consent){ window.location.href = 'index.html'; }
  else { document.getElementById('who').textContent = mail; }
})();

/* ---------- I18N skrót (pozostawione) ---------- */
(function(){
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
  const toggleBtn = document.getElementById('langToggle');

  if(lang==='en'){
    t('backLbl','← Back');
    t('title','Plan generator');
    t('subtitle','Choose mode, answer the questions, and generate the plan. The Excel file will be emailed to you.');
    t('modeLbl','Generator mode');
    document.getElementById('btnA').textContent='Plan A — 12 weeks';
    document.getElementById('btnB').textContent='Plan B — Hybrid week (4 weeks)';
    t('hA','Plan A — questions (5)');
    t('a1lbl','How many sessions per week would you like?');
    t('a2lbl','What is your main goal?');
    t('a3lbl','What is your activity/experience level?');
    document.querySelector('#a3 option[value="Zaawansowany"]').textContent='Advanced';
    document.querySelector('#a3 option[value="Średniozaawansowany"]').textContent='Intermediate';
    document.querySelector('#a3 option[value="Początkujący"]').textContent='Beginner';
    t('a4lbl','What equipment do you have access to?');
    t('a5lbl','Sex');
    document.querySelector('#a5 option[value="Mężczyzna"]').textContent='Male';
    document.querySelector('#a5 option[value="Kobieta"]').textContent='Female';
    document.getElementById('dlBtn').textContent='Download Excel';
    t('whoLbl','The plan will be sent to: ');
    t('rodoLbl','This is not medical advice. Use at your own risk.');
    t('hB','Plan B — questions (10)');
    t('b1lbl','Disciplines (pick or type)'); t('b1hint','Quick pick below — click to add:');
    t('b2lbl','Priority 1'); t('b3lbl','Priority 2');
    t('b4lbl','Sessions/week'); t('b5lbl','Available days');
    t('b6lbl','Time per session (min)'); t('b7lbl','Level');
    t('b8lbl','Equipment'); t('b9lbl','Limitations'); t('b10lbl','Notes');
    t('quickLbl','Quick pick (20 disciplines)');
    localStorage.setItem('hp_lang','en');
    if(toggleBtn){ toggleBtn.href='?lang=pl'; toggleBtn.textContent='PL'; toggleBtn.setAttribute('aria-label','Polish version'); }
  } else {
    localStorage.setItem('hp_lang','pl');
    if(toggleBtn){ toggleBtn.href='?lang=en'; toggleBtn.textContent='EN'; toggleBtn.setAttribute('aria-label','English version'); }
  }
})();

/* ---------- Lista 20 dyscyplin (bez zmian) ---------- */
const DISC = [
  'Siłownia','Bieganie','Wspinaczka','Jazda na rowerze','Pływanie',
  'Joga','Mobility','HIIT','Cross-training','Trening obwodowy',
  'Wioślarz','Sztangi','Kettlebell','Trening kalisteniczny','Pilates',
  'Boks','MMA','Tenis','Badminton','Narciarstwo biegowe'
];
(function(){
  const grid = document.getElementById('discGrid');
  const chips = document.getElementById('chips');
  if(!grid) return;
  DISC.forEach(name=>{
    const b = document.createElement('button');
    b.type='button'; b.className='badge'; b.textContent=name;
    b.addEventListener('click', ()=>{
      const input = document.getElementById('b1');
      const cur = input.value.trim();
      const list = cur ? cur.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if(!list.includes(name)) list.push(name);
      input.value = list.join(', ');
      const c = document.createElement('span'); c.className='badge'; c.textContent=name;
      chips.appendChild(c);
    });
    grid.appendChild(b);
  });
})();

/* ---------- Przełączanie trybów ---------- */
const formA = document.getElementById('formA');
const formB = document.getElementById('formB');
const btnA  = document.getElementById('btnA');
const btnB  = document.getElementById('btnB');
function showA(){ formA.style.display='block'; formB.style.display='none'; btnA.classList.add('btn-brown'); btnB.classList.remove('btn-brown'); }
function showB(){ formA.style.display='none'; formB.style.display='block'; btnB.classList.add('btn-brown'); btnA.classList.remove('btn-brown'); }
btnA.addEventListener('click', showA);
btnB.addEventListener('click', showB);
(function(){ const h=location.hash; if(h && /plan=B/i.test(h)) showB(); else showA(); })();

/* ---------- Zbieranie pól ---------- */
function buildPayload(){
  const usingA = formA.style.display==='block';
  if(usingA){
    return {
      mode: 'A',
      title: 'Plan Treningowy',
      inputs: {
        sessionsPerWeek: Number(document.getElementById('a1').value || 0),
        goal: document.getElementById('a2').value.trim(),
        level: document.getElementById('a3').value,
        equipment: document.getElementById('a4').value.trim(),
        sex: document.getElementById('a5').value   // <— NOWE
      }
    };
  } else {
    return {
      mode: 'B',
      title: 'Hybrydowy Plan Treningowy (4 tygodnie)',
      inputs: {
        disciplines: document.getElementById('b1').value.trim(),
        prio1: document.getElementById('b2').value.trim(),
        prio2: document.getElementById('b3').value.trim(),
        sessionsPerWeek: Number(document.getElementById('b4').value || 0),
        days: document.getElementById('b5').value.trim(),
        minPerSession: Number(document.getElementById('b6').value || 0),
        level: document.getElementById('b7').value,
        equipment: document.getElementById('b8').value.trim(),
        limits: document.getElementById('b9').value.trim(),
        notes: document.getElementById('b10').value.trim(),
      }
    };
  }
}

/* ---------- Wywołanie backendu (Groq → JSON) ---------- */
async function callBackendGenerate(payload){
  const lang = (localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const res = await fetch(window.HP_ENDPOINTS.generate, {
    method: 'POST',
    headers: {'Content-Type':'application/json','Accept':'application/json'},
    body: JSON.stringify({ mode: payload.mode, inputs: payload.inputs, lang })
  });
  const text = await res.text();
  if(!res.ok) throw new Error(`generate-plan HTTP ${res.status}: ${text}`);
  let data; try{ data=JSON.parse(text); }catch{ throw new Error('Bad JSON from generate-plan'); }
  return data; // {planJson, planText, planName}
}

/* ---------- Fallback (stały szablon JSON, FBW PUSH/PULL/LEGS) ---------- */
function localJsonFallback(){
  const D = d=>({day:d, focus:'', exercises:[
    {name:'Flat bench press',sets:4,reps:'8-12',rest:'3min',rir:'1-2',rpe:'9',tempo:'X',comment:'',series:''},
    {name:'Incline bench press',sets:3,reps:'8-12',rest:'3min',rir:'2',rpe:'8',tempo:'X',comment:'',series:''},
    {name:'Overhead press',sets:3,reps:'8-12',rest:'3min',rir:'2',rpe:'8',tempo:'X',comment:'',series:''},
    {name:'Triceps extension',sets:3,reps:'8-12',rest:'2min',rir:'2-3',rpe:'8',tempo:'X',comment:'',series:''},
    {name:'Lateral raise',sets:3,reps:'8-12',rest:'2min',rir:'2-3',rpe:'8',tempo:'X',comment:'',series:''},
    {name:'Hanging knee raises',sets:3,reps:'8-12',rest:'2min',rir:'2-3',rpe:'8',tempo:'X',comment:'',series:''},
  ]});
  return {
    week: [D('Poniedziałek'), D('Wtorek'), D('Środa'), D('Czwartek'), D('Piątek'), D('Sobota'), D('Niedziela')]
  };
}

/* ---------- XLSX: budowa arkusza w stylu z Twoich screenów ---------- */
async function makeWorkbook(planJson, planName='Plan Treningowy'){
  const days = ['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'];
  const headers = ['ĆWICZENIE','SERIE','POWTÓRZENIA','PRZERWA','RIR','RPE','TEMPO','KOMENTARZ / WYKONANIE','NUMER SERII'];
  const colWidths = [34,6,14,10,6,6,8,28,12];

  const wb = await XlsxPopulate.fromBlankAsync();
  // usuń domyślny Sheet1
  wb.deleteSheet(0);

  for(const d of days){
    const sh = wb.addSheet(d);
    // tytuł
    sh.range('A1:I1').merged(true).value(planName)
      .style({ bold:true, fontColor:'000', horizontalAlignment:'center', verticalAlignment:'center', fontSize:22 });
    // pasek nagłówków tabeli
    sh.row(3).style({ bold:true, fill:'D9E2F3', border:true });
    headers.forEach((h,i)=> sh.cell(3, i+1).value(h));
    // szerokości kolumn
    colWidths.forEach((w,i)=> sh.column(i+1).width(w));
    // zamrożenie
    sh.freezePanes(4,1);
    // obramowanie lekkie dla tabeli
    const dayObj = (planJson?.week||[]).find(x=>String(x.day||'').toLowerCase()===d.toLowerCase()) || {exercises:[]};
    const rows = dayObj.exercises||[];
    const startRow = 4;
    rows.forEach((ex,idx)=>{
      const r = startRow+idx;
      const vals = [
        ex.name||'', ex.sets||'', ex.reps||'', ex.rest||'',
        ex.rir||'', ex.rpe||'', ex.tempo||'',
        ex.comment||'', ex.series||''
      ];
      vals.forEach((v,i)=> sh.cell(r,i+1).value(v));
    });
    const lastRow = Math.max(startRow + (rows.length||1) - 1, startRow);
    sh.range(3,1,lastRow,9).style({border:true});
  }

  // ustaw pierwszy jako aktywny
  wb.sheet(0).active(true);
  const blob = await wb.outputAsync();
  return new Blob([blob], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
}

/* ---------- E-mail (Resend przez funkcję) ---------- */
function blobToBase64(blob){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(String(r.result).split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}
async function sendPlanByEmail(xlsxBlob, planName){
  try{
    const to = localStorage.getItem('hp_email');
    if(!to) return;
    const b64 = await blobToBase64(xlsxBlob);
    const resp = await fetch(window.HP_ENDPOINTS.sendEmail, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        to,
        subject: planName || 'Twój plan treningowy',
        html: '<p>W załączniku Twój plan (XLSX). Dziękujemy za skorzystanie z HybridPlanner.</p>',
        attachmentBase64: b64,
        filename: 'Plan Treningowy.xlsx'
      })
    });
    if(!resp.ok){ console.error('Resend error', await resp.text()); alert('Nie udało się wysłać e-maila.'); }
  }catch(e){ console.error(e); }
}

/* ---------- Generowanie ---------- */
const genBtn = document.getElementById('genBtn');
const dlBtn  = document.getElementById('dlBtn');

genBtn.addEventListener('click', async ()=>{
  let planJson, planName='Plan Treningowy';

  try{
    genBtn.disabled = true;
    genBtn.textContent = 'Generowanie…';
    dlBtn.style.display='none'; dlBtn.removeAttribute('href');

    const payload = buildPayload();

    // 1) Backend (Groq)
    try{
      const data = await callBackendGenerate(payload);
      planName = data.planName || planName;
      planJson = data.planJson || null;
    }catch(err){
      console.warn('Backend nie zwrócił JSON, używam fallbacku:', err);
      planJson = localJsonFallback();
    }

    // 2) XLSX
    const xlsxBlob = await makeWorkbook(planJson, planName);
    const url = URL.createObjectURL(xlsxBlob);
    dlBtn.href = url; dlBtn.style.display='inline-flex';

    // 3) E-mail
    await sendPlanByEmail(xlsxBlob, planName);

    genBtn.textContent = 'Gotowe ✓';
  }catch(e){
    console.error(e);
    alert('Nie udało się wygenerować planu.');
    genBtn.textContent = 'Wygeneruj plan';
  }finally{
    genBtn.disabled = false;
  }
});

/* ---------- Hash → przełącznik ---------- */
window.addEventListener('hashchange', ()=>{
  if(/plan=B/i.test(location.hash)) showB();
  if(/plan=A/i.test(location.hash)) showA();
});
</script>
</body>
</html>
