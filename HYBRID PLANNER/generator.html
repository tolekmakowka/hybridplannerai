<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HybridPlanner — Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3E2723; --white:#FFFFFF; --beige:#8D8C87;
  --text:#EDEDEA; --muted:#C9C7C2; --bg:#0F0F0F; --card:#1B1B1B;
  --border:#2A2A2A; --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
  --maxw:980px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit;text-decoration:none}
h1{font:700 34px/1.2 Poppins;margin:0 0 8px}
h2{font:700 22px/1.25 Poppins;margin:14px 0 8px}
label{font:600 14px/1.4 Inter}
small{color:#a9a7a3}

.container{max-width:var(--maxw);margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
.lang-toggle{
  background:#111; color:#fff; border:1px solid #333;
  padding:6px 10px; border-radius:10px; font:600 12px/1 Inter; text-decoration:none;
}

.card{background:#141414;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row{display:grid;gap:8px;margin:10px 0}
input[type="text"], input[type="number"], input[type="email"], select, textarea{
  width:100%;background:#0f0f0f;color:#fff;border:1px solid #3a3a3a;border-radius:10px;padding:10px;font:400 14px/1.4 Inter
}
textarea{min-height:90px;resize:vertical}
.badge{
  display:inline-block;background:#1e1e1e;border:1px solid #303030;border-radius:999px;padding:6px 10px;font:600 12px/1 Inter;margin-right:8px;margin-bottom:8px;color:#fff;
}
.btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;border:2px solid var(--text);color:var(--text);background:transparent;font:600 16px/1 Inter;cursor:pointer}
.btn-brown{background:var(--brown);border-color:var(--brown);color:#fff}
.btn-ghost{background:transparent;border-color:#3a3a3a;color:#ddd}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.hr{height:1px;background:#2A2A2A;margin:18px 0}

.notice{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px dashed #3a3a3a;border-radius:12px;padding:10px 12px;margin-top:12px}
footer{margin:30px 0 10px;color:#a9a7a3;font-size:12px;text-align:center}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a class="back" href="index.html" id="backLbl">← Wróć</a>
    <a id="langToggle" class="lang-toggle" href="?lang=en" aria-label="English version">EN</a>
  </div>

  <div class="card">
    <h1 id="title">Generator planów</h1>
    <p id="subtitle" style="margin:6px 0 14px;color:#C9C7C2">
      Wybierz tryb, odpowiedz na pytania i wygeneruj plan. <strong>Plik Excel</strong> zostanie wysłany na Twój e-mail.
    </p>

    <!-- wybór trybu -->
    <div class="row">
      <label id="modeLbl">Tryb generatora</label>
      <div class="actions">
        <button class="btn btn-ghost" id="btnA">Plan A — 12 tygodni</button>
        <button class="btn btn-ghost" id="btnB">Plan B — Hybrydowy tydzień (4 tygodnie)</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- PLAN A — 5 pytań (DOMYŚLNIE WIDOCZNY) -->
    <section id="formA" style="display:block">
      <h2 id="hA">Plan A — pytania (5)</h2>
      <div class="grid-2">
        <div class="row">
          <label id="a1lbl">Ile razy w tygodniu chciałbyś/chciałabyś ćwiczyć?</label>
          <input id="a1" type="number" min="1" max="14" value="4">
        </div>
        <div class="row">
          <label id="a2lbl">Jaki jest twój główny cel?</label>
          <input id="a2" type="text" placeholder="np. zwiększyć siłę / redukcja tkanki tłuszczowej">
        </div>
        <div class="row">
          <label id="a3lbl">Jaki jest twój poziom aktywności fizycznej?</label>
          <select id="a3">
            <option>Zaawansowany</option>
            <option>Średniozaawansowany</option>
            <option>Początkujący</option>
          </select>
        </div>
        <div class="row">
          <label id="a4lbl">Do jakiego sprzętu treningowego masz dostęp?</label>
          <input id="a4" type="text" placeholder="np. siłownia pełna / hantle + drążek / dom">
        </div>
        <div class="row">
          <label id="a5lbl">Czy chcesz trenować konkretnym schematem czy mam dopasować?</label>
          <select id="a5">
            <option>FBW</option>
            <option>PPL</option>
            <option>Arnold Split</option>
            <option>Upper Lower</option>
            <option>Dopasowany do twoich potrzeb</option>
          </select>
        </div>
      </div>
    </section>

    <!-- PLAN B -->
    <section id="formB" style="display:none">
      <h2 id="hB">Plan B — pytania (10)</h2>
      <div class="grid-2">
        <div class="row"><label id="b1lbl">Dyscypliny (wybierz z listy lub wpisz)</label>
          <input id="b1" type="text" placeholder="np. siłownia, bieganie, wspinaczka">
          <small id="b1hint">Szybki wybór poniżej — kliknij, by dodać:</small>
          <div id="chips" style="margin-top:8px"></div>
        </div>
        <div class="row"><label id="b2lbl">Priorytet 1</label><input id="b2" type="text" placeholder="np. bieg 5 km / siła nóg"></div>
        <div class="row"><label id="b3lbl">Priorytet 2</label><input id="b3" type="text" placeholder="opcjonalnie"></div>
        <div class="row"><label id="b4lbl">Liczba jednostek/tydzień</label><input id="b4" type="number" min="1" max="14" value="4"></div>
        <div class="row"><label id="b5lbl">Dostępne dni</label><input id="b5" type="text" placeholder="np. pn, śr, pt, sob"></div>
        <div class="row"><label id="b6lbl">Czas na jednostkę (min)</label><input id="b6" type="number" min="20" max="180" value="60"></div>
        <div class="row"><label id="b7lbl">Poziom</label>
          <select id="b7"><option>Początkujący</option><option>Średniozaawansowany</option><option>Zaawansowany</option></select>
        </div>
        <div class="row"><label id="b8lbl">Sprzęt</label><input id="b8" type="text" placeholder="np. siłownia / dom / ścianka"></div>
        <div class="row"><label id="b9lbl">Ograniczenia</label><input id="b9" type="text" placeholder="np. brak skoków / bez sprintów"></div>
        <div class="row"><label id="b10lbl">Uwagi</label><textarea id="b10" placeholder="dodatkowe informacje"></textarea></div>
      </div>
      <div class="hr"></div>
      <div>
        <label id="quickLbl">Szybki wybór (20 dyscyplin)</label>
        <div class="grid-3" id="discGrid" style="margin-top:8px"></div>
      </div>
    </section>

    <div class="hr"></div>

    <div class="actions">
      <button id="genBtn" class="btn btn-brown">Wygeneruj plan</button>
      <a id="dlBtn" class="btn btn-ghost" href="#" download="plan.xlsx" style="display:none">Pobierz plik Excel</a>
    </div>

    <div class="notice">
      <small id="whoLbl">Plan zostanie wysłany na e-mail: <strong id="who"></strong></small>
      <small id="rodoLbl">To nie jest porada medyczna. Korzystasz na własną odpowiedzialność.</small>
    </div>
  </div>

  <footer>© 2025 Anatol Makówka</footer>
</div>

<!-- XLSX (XlsxPopulate do stylowania w przeglądarce) -->
<script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>

<script>
/* ---------- KONFIG do Netlify Functions (GROQ backend) ---------- */
window.HP_ORIGIN = 'https://hybridplannerai.netlify.app';
window.HP_ENDPOINTS = {
  generate: window.HP_ORIGIN + '/.netlify/functions/generate-plan',
  sendEmail: window.HP_ORIGIN + '/.netlify/functions/send-email'
};
</script>

<script>
/* ---------- Bramka e-mail ---------- */
(function(){
  const mail = localStorage.getItem('hp_email');
  const consent = localStorage.getItem('hp_consent');
  if(!mail || !consent){ window.location.href = 'index.html'; }
  else { document.getElementById('who').textContent = mail; }
})();

/* ---------- I18N (bez zmian, skrót) ---------- */
(function(){
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
  const toggleBtn = document.getElementById('langToggle');

  if(lang==='en'){
    t('backLbl','← Back');
    t('title','Plan generator');
    t('subtitle','Choose mode, answer the questions, and generate the plan. The Excel file will be emailed to you.');
    t('modeLbl','Generator mode');
    document.getElementById('btnA').textContent='Plan A — 12 weeks';
    document.getElementById('btnB').textContent='Plan B — Hybrid week (4 weeks)';
    t('hA','Plan A — questions (5)');
    t('a1lbl','How many sessions per week would you like?');
    t('a2lbl','What is your main goal?');
    t('a3lbl','What is your activity/experience level?');
    document.querySelector('#a3 option[value="Zaawansowany"]').textContent='Advanced';
    document.querySelector('#a3 option[value="Średniozaawansowany"]').textContent='Intermediate';
    document.querySelector('#a3 option[value="Początkujący"]').textContent='Beginner';
    t('a4lbl','What equipment do you have access to?');
    t('a5lbl','Do you want a specific split or should I pick the best match?');

    t('hB','Plan B — questions (10)');
    t('b1lbl','Disciplines (pick or type)'); t('b1hint','Quick pick below — click to add:');
    t('b2lbl','Priority 1'); t('b3lbl','Priority 2');
    t('b4lbl','Sessions/week'); t('b5lbl','Available days');
    t('b6lbl','Time per session (min)'); t('b7lbl','Level');
    t('b8lbl','Equipment'); t('b9lbl','Limitations'); t('b10lbl','Notes');
    t('quickLbl','Quick pick (20 disciplines)');

    document.getElementById('genBtn').textContent='Generate plan';
    document.getElementById('dlBtn').textContent='Download Excel file';

    localStorage.setItem('hp_lang','en');
    if(toggleBtn){ toggleBtn.href='?lang=pl'; toggleBtn.textContent='PL'; toggleBtn.setAttribute('aria-label','Polish version'); }
  } else {
    localStorage.setItem('hp_lang','pl');
    if(toggleBtn){ toggleBtn.href='?lang=en'; toggleBtn.textContent='EN'; toggleBtn.setAttribute('aria-label','English version'); }
  }
})();

/* ---------- Lista 20 dyscyplin ---------- */
const DISC = [
  'Siłownia','Bieganie','Wspinaczka','Jazda na rowerze','Pływanie',
  'Joga','Mobility','HIIT','Cross-training','Trening obwodowy',
  'Wioślarz','Sztangi','Kettlebell','Trening kalisteniczny','Pilates',
  'Boks','MMA','Tenis','Badminton','Narciarstwo biegowe'
];
(function(){
  const grid = document.getElementById('discGrid');
  const chips = document.getElementById('chips');
  if(!grid) return;
  DISC.forEach(name=>{
    const b = document.createElement('button');
    b.type='button'; b.className='badge'; b.textContent=name;
    b.addEventListener('click', ()=>{
      const input = document.getElementById('b1');
      const cur = input.value.trim();
      const list = cur ? cur.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if(!list.includes(name)) list.push(name);
      input.value = list.join(', ');
      const c = document.createElement('span'); c.className='badge'; c.textContent=name;
      chips.appendChild(c);
    });
    grid.appendChild(b);
  });
})();
</script>

<script>
/* ---------- Przełączanie trybów (A domyślnie widoczny) ---------- */
const formA = document.getElementById('formA');
const formB = document.getElementById('formB');
const btnA  = document.getElementById('btnA');
const btnB  = document.getElementById('btnB');

function showA(){ formA.style.display='block'; formB.style.display='none'; btnA.classList.add('btn-brown'); btnB.classList.remove('btn-brown'); }
function showB(){ formA.style.display='none'; formB.style.display='block'; btnB.classList.add('btn-brown'); btnA.classList.remove('btn-brown'); }

btnA.addEventListener('click', showA);
btnB.addEventListener('click', showB);
(function(){
  const h = location.hash;
  if(h && /plan=B/i.test(h)) showB();
  else showA();
})();
</script>

<script>
/* ---------- Budowa payloadu (bez zmian merytorycznych) ---------- */
function buildPayload(){
  const usingA = formA.style.display==='block';
  if(usingA){
    return {
      mode: 'A',
      title: 'Plan Treningowy',
      inputs: {
        sessionsPerWeek: Number(document.getElementById('a1').value || 0),
        goal: document.getElementById('a2').value.trim(),
        level: document.getElementById('a3').value,
        equipment: document.getElementById('a4').value.trim(),
        splitPreference: document.getElementById('a5').value
      }
    };
  } else {
    return {
      mode: 'B',
      title: 'Hybrydowy Plan Treningowy',
      inputs: {
        disciplines: document.getElementById('b1').value.trim(),
        prio1: document.getElementById('b2').value.trim(),
        prio2: document.getElementById('b3').value.trim(),
        sessionsPerWeek: Number(document.getElementById('b4').value || 0),
        days: document.getElementById('b5').value.trim(),
        minPerSession: Number(document.getElementById('b6').value || 0),
        level: document.getElementById('b7').value,
        equipment: document.getElementById('b8').value.trim(),
        limits: document.getElementById('b9').value.trim(),
        notes: document.getElementById('b10').value.trim(),
      }
    };
  }
}

/* ---------- PROMPT (jak wcześniej, skrót zasad) ---------- */
function buildPrompt(payload, lang){
  const L = (lang || localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const isEN = L === 'en';
  const A = payload.mode === 'A';

  const dayNamesPL = ['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'];

  const header = A
    ? `ROLA: Doświadczony trener S&C. Stwórz uporządkowany plan.\nTYTUŁ: Plan Treningowy`
    : `ROLA: Doświadczony trener S&C. Stwórz uporządkowany plan hybrydowy (4 tygodnie).\nTYTUŁ: Hybrydowy Plan Treningowy`;

  const inputsBlock = Object.entries(payload.inputs).map(([k,v])=>`- ${k}: ${v ?? '—'}`).join('\n');

  const RULES = `
FORMAT:
- Każdy dzień treningowy ma nazwę dnia tygodnia i typ (np. PUSH/PULL/LEGS/UPPER/LOWER).
- 5–8 ćwiczeń dziennie; każde 3–4 serie i 8–12 powtórzeń.
- Używaj ćwiczeń z listy: Flat bench press, Incline bench press, Pec deck, Lat pulldown, Close grip horizontal row, Horizontal row 45*, Bent over row, Overhead press, Face pull, Lateral raise, Biceps curl, Hammer curl, Triceps extension, Triceps overhead extension, Hanging knee raises, Forearm curl, Deadlift, Leg curl, Squat, Leg extension, Calf raises.
- Zapis ćwiczeń w linii: „• Nazwa — 4×8–12”.
- Zapewnij 24–48 h przerwy dla tych samych partii.
WYJŚCIE:
- Zwykły tekst. Tygodnie „Tydzień X”, dni np. „Dzień 1 — Poniedziałek (PUSH)”.
- Zakończ zdaniem: „To nie jest porada medyczna.”
`.trim();

  const REQ = A
    ? `Nazwy dni tygodnia: ${dayNamesPL.join(', ')}. Uwzględnij split: ${payload.inputs.splitPreference}.`
    : `Ułóż 4 tygodnie; podziel dni na treningowe i nietreningowe; jeśli siłownia — wskaż Upper/Lower.`;

  return [header, '', 'DANE WEJŚCIOWE:', inputsBlock, '', RULES, '', REQ].join('\n');
}

/* ---------- Wywołanie backendu (GROQ) ---------- */
async function callBackendGenerateWithPrompt(payload){
  const lang = (localStorage.getItem('hp_lang') || 'pl').toLowerCase();
  const prompt = buildPrompt(payload, lang);

  const res = await fetch(window.HP_ENDPOINTS.generate, {
    method: 'POST',
    mode: 'cors',
    headers: {'Content-Type':'application/json', 'Accept':'application/json'},
    body: JSON.stringify({ mode: payload.mode, inputs: payload.inputs, lang, prompt })
  });

  const text = await res.text();
  if(!res.ok){ throw new Error(`generate-plan HTTP ${res.status}: ${text}`); }

  let data;
  try { data = JSON.parse(text); }
  catch { throw new Error('Nieprawidłowy JSON z generate-plan: ' + text.slice(0,200)); }

  if(!data || !data.planText){
    throw new Error('Brak planText w odpowiedzi generate-plan.');
  }
  return { planText: data.planText, planName: data.planName || (payload.mode==='A'?'Plan Treningowy':'Hybrydowy Plan Treningowy') };
}

/* ---------- Parser tekstu → sekcje / ćwiczenia ---------- */
function parsePlanText(planText){
  const lines = (planText || '').split(/\r?\n/);
  const sections = [];
  let cur = null;

  const dayReg = /^(?:Dzień\s*\d+\s*[—-]\s*(.+)|Poniedziałek|Wtorek|Środa|Czwartek|Piątek|Sobota|Niedziela)/i;

  for(const raw of lines){
    const l = raw.trim();
    if(!l) continue;

    const m = l.match(dayReg);
    if(m){
      if(cur) sections.push(cur);
      const label = m[1] ? m[1] : l;
      cur = { label, items: [] };
      continue;
    }

    if(/^•/.test(l) || /^-\s*/.test(l)){
      const text = l.replace(/^•\s*|^-+\s*/,'').trim();
      const parts = text.split(/[—–-]+/);
      const name = (parts[0] || '').trim();
      let series='', reps='';
      if(parts[1]){
        const m2 = parts[1].match(/(\d+)\s*[x×]\s*([\d–\-]+(?:–\d+)?)/i);
        if(m2){ series = m2[1]; reps = m2[2].replace('-', '–'); }
      }
      if(name) cur?.items.push({ name, series, reps });
    }
  }
  if(cur) sections.push(cur);
  return sections;
}

/* ---------- XLSX (XlsxPopulate) ---------- */
async function makeXlsx(planText, planName){
  const sections = parsePlanText(planText);

  const X = await XlsxPopulate.fromBlankAsync();
  const sheet = X.sheet(0).name("Plan");

  const headers = ["ĆWICZENIE","SERIE","POWTÓRZENIA","PRZERWA","RIR","RPE","TEMPO","KOMENTARZ / WYKONANIE","NUMER SERII"];
  const widths  = [44,10,16,14,8,8,10,34,14];
  headers.forEach((_, i)=> sheet.column(i+1).width(widths[i]));
  sheet.row(1).height(26);

  sheet.cell("A1").value(planName || "Plan Treningowy").style({ bold:true, fontSize:16 });
  sheet.range("A1:I1").merged(true);

  let r = 3;
  const blueBar = "#1F4E79";
  const blueHead= "#DBECFF";
  const border  = "thin";

  function styleRange(a1, b1, style){ sheet.range(a1+":"+b1).style(style); }

  for(const sec of sections){
    styleRange(`A${r}`,`I${r}`,{ bold:true, fill:blueBar, fontColor:"ffffff", horizontalAlignment:"left", verticalAlignment:"center" });
    sheet.row(r).height(22);
    sheet.cell(`A${r}`).value(sec.label);
    sheet.range(`A${r}:I${r}`).merged(true);
    r++;

    headers.forEach((h,i)=> sheet.cell(r,i+1).value(h));
    styleRange(`A${r}`,`I${r}`,{ bold:true, fill:blueHead, horizontalAlignment:"center", verticalAlignment:"center", border:true, borderStyle:border, wrapText:true });
    sheet.row(r).height(22);
    r++;

    for(const it of sec.items){
      sheet.cell(r,1).value(it.name);
      sheet.cell(r,2).value(it.series || "");
      sheet.cell(r,3).value(it.reps   || "");
      sheet.cell(r,4).value("2MIN");
      sheet.cell(r,5).value("X");
      sheet.cell(r,6).value("8");
      sheet.cell(r,7).value("X");
      sheet.cell(r,8).value("");
      sheet.cell(r,9).value("");
      styleRange(`A${r}`,`I${r}`,{ border:true, borderStyle:border, verticalAlignment:"center" });
      r++;
    }
    r++;
  }

  const blob = await X.outputAsync();
  const url  = URL.createObjectURL(blob);
  return { blob, url };
}

/* ---------- Mail (Resend) z XLSX ---------- */
function blobToBase64(blob){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(String(r.result).split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}
async function sendPlanByEmail(xlsxBlob, planName){
  try {
    const to = localStorage.getItem('hp_email');
    if(!to){ console.warn('Brak e-maila w localStorage (hp_email).'); return; }
    const b64 = xlsxBlob ? await blobToBase64(xlsxBlob) : null;

    const resp = await fetch(window.HP_ENDPOINTS.sendEmail, {
      method: 'POST',
      mode: 'cors',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        to,
        subject: planName || 'Twój plan treningowy',
        html: '<p>W załączniku Twój plan w formacie <strong>Excel (xlsx)</strong>. Dziękujemy za skorzystanie z HybridPlanner.</p>',
        attachmentBase64: b64,
        filename: 'plan.xlsx'
      })
    });

    if(!resp.ok){
      const t = await resp.text();
      console.error('Resend error:', t);
      alert('Nie udało się wysłać e-maila. Spróbuj ponownie.');
    }
  } catch(e){ console.error(e); }
}
window.hpOnPlanReady = async function(fileBlob, planName){
  try { await sendPlanByEmail(fileBlob, planName); }
  catch(e){ console.error(e); }
};

/* ---------- Generowanie ---------- */
const genBtn = document.getElementById('genBtn');
const dlBtn  = document.getElementById('dlBtn');

genBtn.addEventListener('click', async ()=>{
  let planText, planName;

  try{
    genBtn.disabled = true;
    genBtn.textContent = 'Generowanie…';
    dlBtn.style.display='none'; dlBtn.removeAttribute('href');

    const payload = buildPayload();

    const { planText: txt, planName: name } = await callBackendGenerateWithPrompt(payload);
    planText = txt; planName = name;

    const { blob, url } = await makeXlsx(planText, planName);
    dlBtn.href = url; dlBtn.style.display='inline-flex';

    await window.hpOnPlanReady(blob, planName);
    genBtn.textContent = 'Gotowe ✓';
  }catch(e){
    console.error(e);
    alert('Nie udało się wygenerować planu.');
    genBtn.textContent = 'Wygeneruj plan';
  }finally{
    genBtn.disabled = false;
  }
});

/* ---------- Hash → przełącznik ---------- */
window.addEventListener('hashchange', ()=>{
  if(/plan=B/i.test(location.hash)) showB();
  if(/plan=A/i.test(location.hash)) showA();
});
</script>
</body>
</html>
